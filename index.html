<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VisitaFiliais</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;9..144,400;9..144,600;9..144,700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>

:root {
  --bg:#0a0e1a; --panel:#111827; --panel2:#1a2235; --panel3:#222f45;
  --accent:#00d4aa; --accent2:#0088ff; --warn:#ff6b35; --danger:#ef4444;
  --text:#e8edf5; --muted:#6b7a99; --border:#1e2d45; --border2:#263554;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:62px;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0;z-index:1000;}
.logo{display:flex;align-items:center;gap:12px;}
.logo-mark{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.logo h1{font-family:'Fraunces',serif;font-size:18px;font-weight:600;letter-spacing:-0.5px;}
.logo span{font-size:11px;color:var(--muted);font-weight:400;letter-spacing:0.3px;}
.header-center{display:flex;gap:4px;}
.nav-tab{padding:6px 16px;border-radius:8px;border:none;cursor:pointer;font-family:'Inter',sans-serif;font-size:13px;font-weight:500;background:transparent;color:var(--muted);transition:all 0.18s;}
.nav-tab:hover,.nav-tab.active{color:var(--text);background:var(--panel2);}
.nav-tab.active-settings{color:var(--accent);background:rgba(0,212,170,0.08);}
.header-stats{display:flex;gap:32px;}
.stat{text-align:center;}
.stat-num{font-family:'Fraunces',serif;font-size:22px;font-weight:600;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;}
.stat-label{font-size:10px;color:var(--muted);margin-top:3px;font-weight:400;letter-spacing:0.5px;}
.header-actions{display:flex;gap:10px;align-items:center;}

/* BUTTONS */
.btn{padding:8px 18px;border-radius:8px;border:none;cursor:pointer;font-family:'Inter',sans-serif;font-size:13px;font-weight:500;transition:all 0.2s;}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;}
.btn-primary:hover{opacity:0.85;transform:translateY(-1px);}
.btn-ghost{background:var(--panel2);color:var(--text);border:1px solid var(--border);}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
.btn-danger{background:rgba(239,68,68,0.12);color:var(--danger);border:1px solid rgba(239,68,68,0.25);}
.btn-danger:hover{background:rgba(239,68,68,0.22);}
.btn-sm{padding:5px 12px;font-size:12px;}
.btn-warn{background:rgba(255,107,53,0.12);color:var(--warn);border:1px solid rgba(255,107,53,0.25);}
.btn-warn:hover{background:rgba(255,107,53,0.22);}

/* VIEWS */
.main{display:flex;flex:1;overflow:hidden;}
.view{display:none;width:100%;height:100%;}
.view.active{display:flex;}
#view-map{flex-direction:row;overflow:hidden;}
#view-settings{flex-direction:row;overflow:hidden;}

/* SIDEBAR */
.sidebar{width:300px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;transition:width 0.3s cubic-bezier(0.4,0,0.2,1);overflow:hidden;}
.sidebar.collapsed{width:0;border-right-color:transparent;}
.sidebar.collapsed .sidebar-inner{opacity:0;pointer-events:none;}
.sidebar-inner{width:300px;min-width:300px;display:flex;flex-direction:column;flex:1;overflow:hidden;transition:opacity 0.15s;}
.sidebar-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.sidebar-title{font-family:'Inter',sans-serif;font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.search-wrap{padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0;}
.search-box{position:relative;display:flex;align-items:center;}
.search-box svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:15px;height:15px;color:var(--muted);pointer-events:none;}
.search-box input{width:100%;padding:8px 12px 8px 34px;background:var(--panel2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Inter',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;}
.search-box input:focus{border-color:var(--accent);}
.search-box input::placeholder{color:var(--muted);}
.filter-tabs{display:flex;gap:5px;padding:10px 16px;border-bottom:1px solid var(--border);flex-wrap:wrap;flex-shrink:0;}
.filter-tab{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all 0.2s;font-family:'Inter',sans-serif;}
.filter-tab.active,.filter-tab:hover{background:var(--accent);color:#000;border-color:var(--accent);}
.filiais-list{flex:1;overflow-y:auto;padding:8px 10px;}
.filiais-list::-webkit-scrollbar{width:3px;}
.filiais-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.state-group{margin-bottom:4px;}
.state-label{font-family:'Inter',sans-serif;font-size:9px;font-weight:600;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);padding:10px 8px 4px;}
.filial-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;cursor:pointer;transition:all 0.15s;border:1px solid transparent;}
.filial-item:hover{background:var(--panel2);border-color:var(--border);}
.filial-item.active{background:rgba(0,212,170,0.08);border-color:rgba(0,212,170,0.3);}
.filial-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;}
.filial-dot.visited{background:var(--accent2);}
.filial-dot.pending{background:var(--warn);}
.filial-name{font-size:13px;font-weight:400;flex:1;letter-spacing:-0.1px;}
.filial-badge{font-size:10px;padding:2px 7px;border-radius:10px;font-weight:500;}
.badge-visited{background:rgba(0,136,255,0.15);color:var(--accent2);}
.badge-pending{background:rgba(255,107,53,0.15);color:var(--warn);}
.badge-ok{background:rgba(0,212,170,0.12);color:var(--accent);}

/* MAP */
.map-container{flex:1;position:relative;overflow:hidden;}
#map{width:100%;height:100%;background:#0d1b2e;}
.leaflet-tile-pane{filter:brightness(0.85) saturate(0.6) hue-rotate(180deg);}
.sidebar-toggle{position:absolute;top:50%;transform:translateY(-50%);left:0;z-index:600;width:22px;height:52px;background:var(--panel);border:1px solid var(--border);border-left:none;border-radius:0 10px 10px 0;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:10px;transition:all 0.2s;box-shadow:3px 0 14px rgba(0,0,0,0.5);}
.sidebar-toggle:hover{background:var(--panel2);color:var(--accent);border-color:var(--accent);}
.toggle-icon{display:inline-block;transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);}

/* MAP FILTERS */
.map-filters{position:absolute;top:16px;left:16px;z-index:500;display:flex;flex-direction:column;gap:8px;max-width:240px;}
.map-filter-group{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px 14px;}
.map-filter-title{font-family:'Inter',sans-serif;font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.map-filter-chips{display:flex;flex-wrap:wrap;gap:5px;}
.map-chip{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all 0.18s;font-family:'Inter',sans-serif;white-space:nowrap;}
.map-chip:hover{border-color:var(--accent);color:var(--accent);}
.map-chip.active-status-all{background:rgba(255,255,255,0.08);color:var(--text);border-color:rgba(255,255,255,0.2);}
.map-chip.active-status-ok{background:rgba(0,212,170,0.15);color:var(--accent);border-color:var(--accent);}
.map-chip.active-status-visited{background:rgba(0,136,255,0.15);color:var(--accent2);border-color:var(--accent2);}
.map-chip.active-status-pending{background:rgba(255,107,53,0.15);color:var(--warn);border-color:var(--warn);}
.map-chip.active-uf{background:rgba(0,212,170,0.15);color:var(--accent);border-color:var(--accent);}
.chip-clear{display:none;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid rgba(255,107,53,0.4);background:rgba(255,107,53,0.1);color:var(--warn);font-family:'Inter',sans-serif;transition:all 0.18s;margin-top:6px;}
.chip-clear.visible{display:flex;}
.chip-clear:hover{background:rgba(255,107,53,0.2);}
.map-legend{position:absolute;bottom:30px;right:20px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px 18px;z-index:500;}
.legend-title{font-family:'Inter',sans-serif;font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.legend-item{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:12px;color:var(--text);}
.legend-dot{width:10px;height:10px;border-radius:50%;}

/* SETTINGS LAYOUT */
.settings-nav{width:220px;flex-shrink:0;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:24px 12px;gap:2px;overflow-y:auto;}
.settings-nav-section{font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:16px 12px 6px;margin-top:4px;}
.settings-nav-section:first-child{padding-top:4px;}
.settings-nav-item{display:flex;align-items:center;gap:10px;padding:9px 14px;border-radius:9px;cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);border:1px solid transparent;transition:all 0.15s;background:transparent;font-family:'Inter',sans-serif;text-align:left;width:100%;}
.settings-nav-item:hover{color:var(--text);background:var(--panel2);border-color:var(--border);}
.settings-nav-item.active{color:var(--text);background:var(--panel2);border-color:var(--border);}
.settings-nav-item.active .nav-icon{color:var(--accent);}
.nav-icon{font-size:15px;flex-shrink:0;}
.settings-content{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.settings-panel{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0;}
.settings-panel.active{display:flex;}
.settings-scroll{flex:1;overflow-y:auto;padding:28px 36px;display:flex;flex-direction:column;gap:24px;min-height:0;}
.settings-scroll::-webkit-scrollbar{width:4px;}
.settings-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.settings-save-bar{background:var(--panel);border-top:1px solid var(--border);padding:14px 36px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.save-hint{font-size:12px;color:var(--muted);}

/* SETTINGS SECTIONS */
.settings-section{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:visible;flex-shrink:0;}
.settings-section-header{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.settings-section-title{font-family:'Fraunces',serif;font-size:16px;font-weight:600;letter-spacing:-0.3px;}
.settings-section-desc{font-size:12px;color:var(--muted);margin-top:2px;}
.settings-section-body{padding:22px;}

/* TABLE */
.filiais-table-wrap{max-height:320px;overflow-y:auto;}
.filiais-table-wrap::-webkit-scrollbar{width:3px;}
.filiais-table-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.filiais-table{width:100%;border-collapse:collapse;}
.filiais-table th{text-align:left;padding:10px 14px;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--panel);z-index:1;}
.filiais-table td{padding:11px 14px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;}
.filiais-table tr:last-child td{border-bottom:none;}
.filiais-table tr:hover td{background:var(--panel2);}
.td-actions{display:flex;gap:6px;justify-content:flex-end;}
.state-tag{display:inline-block;padding:2px 8px;border-radius:6px;background:var(--panel2);border:1px solid var(--border);font-size:11px;font-weight:600;color:var(--muted);letter-spacing:0.5px;}
.add-filial-form{display:grid;grid-template-columns:1fr 80px 1fr auto;gap:10px;align-items:end;padding:16px 22px;border-top:1px solid var(--border);background:var(--panel2);}
.form-field{display:flex;flex-direction:column;gap:5px;}
.form-field label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.form-input{width:100%;padding:8px 12px;background:var(--panel);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Inter',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;}
.form-input:focus{border-color:var(--accent);}
.form-input::placeholder{color:var(--muted);}

/* STATUS CONFIG */
.status-config-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.status-card{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:18px;}
.status-card-header{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.status-dot-big{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.status-card-title{font-family:'Fraunces',serif;font-size:15px;font-weight:600;}
.status-card-subtitle{font-size:11px;color:var(--muted);margin-top:1px;}
.config-row{display:flex;flex-direction:column;gap:5px;margin-bottom:12px;}
.config-label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.config-input{width:100%;padding:8px 12px;background:var(--panel);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Inter',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;}
.config-input:focus{border-color:var(--accent);}
.color-row{display:flex;gap:8px;align-items:center;}
.color-input{width:38px;height:34px;border-radius:8px;border:1px solid var(--border);padding:3px;background:var(--panel);cursor:pointer;outline:none;}
.color-input::-webkit-color-swatch-wrapper{padding:0;border-radius:5px;}
.color-input::-webkit-color-swatch{border:none;border-radius:5px;}

/* TOGGLES */
.display-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--panel2);border:1px solid var(--border);border-radius:10px;}
.toggle-label{font-size:13px;font-weight:500;}
.toggle-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.toggle-switch{position:relative;width:40px;height:22px;flex-shrink:0;cursor:pointer;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:22px;transition:0.25s;}
.toggle-slider:before{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:white;left:3px;top:3px;transition:0.25s;}
.toggle-switch input:checked + .toggle-slider{background:var(--accent);}
.toggle-switch input:checked + .toggle-slider:before{transform:translateX(18px);}

/* USERS */
.users-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.users-search{flex:1;min-width:180px;position:relative;}
.users-search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;color:var(--muted);pointer-events:none;}
.users-search input{width:100%;padding:8px 12px 8px 32px;background:var(--panel);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Inter',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;}
.users-search input:focus{border-color:var(--accent);}
.users-search input::placeholder{color:var(--muted);}
.role-filter-chip{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all 0.18s;font-family:'Inter',sans-serif;}
.role-filter-chip:hover,.role-filter-chip.active{background:var(--panel2);color:var(--text);border-color:var(--border2);}

.users-table-wrap{overflow-x:auto;}
.users-table{width:100%;border-collapse:collapse;}
.users-table th{text-align:left;padding:10px 16px;font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--panel);z-index:1;white-space:nowrap;}
.users-table td{padding:13px 16px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;}
.users-table tbody tr:last-child td{border-bottom:none;}
.users-table tbody tr:hover td{background:rgba(26,34,53,0.5);}
.user-avatar{width:36px;height:36px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-family:'Fraunces',serif;font-size:14px;font-weight:600;color:#fff;}
.user-name-cell{display:flex;align-items:center;gap:12px;}
.user-name{font-size:13px;font-weight:600;letter-spacing:-0.1px;}
.user-email{font-size:11px;color:var(--muted);margin-top:1px;}
.status-pill{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:500;}
.status-pill.active{background:rgba(0,212,170,0.12);color:var(--accent);border:1px solid rgba(0,212,170,0.25);}
.status-pill.inactive{background:rgba(107,122,153,0.1);color:var(--muted);border:1px solid var(--border);}
.status-pill-dot{width:6px;height:6px;border-radius:50%;}
.role-badge{font-size:10px;font-weight:600;padding:3px 9px;border-radius:6px;letter-spacing:0.3px;display:inline-block;}
.role-admin  {background:rgba(239,68,68,0.12);  color:#f87171; border:1px solid rgba(239,68,68,0.25);}
.role-diretor{background:rgba(168,85,247,0.12); color:#c084fc; border:1px solid rgba(168,85,247,0.25);}
.role-gerente{background:rgba(0,136,255,0.12);  color:#60a5fa; border:1px solid rgba(0,136,255,0.25);}
.role-coord  {background:rgba(0,212,170,0.12);  color:#34d399; border:1px solid rgba(0,212,170,0.25);}
.td-actions{display:flex;gap:5px;justify-content:flex-end;}

.users-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.summary-card{background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px;}
.summary-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.summary-num{font-family:'Fraunces',serif;font-size:20px;font-weight:600;line-height:1;}
.summary-label{font-size:10px;color:var(--muted);margin-top:2px;letter-spacing:0.3px;}

/* PROFILES */
.profiles-tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);margin-bottom:22px;}
.profile-tab{padding:9px 20px;border:none;background:transparent;color:var(--muted);font-family:'Inter',sans-serif;font-size:13px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.18s;display:flex;align-items:center;gap:7px;}
.profile-tab:hover{color:var(--text);}
.profile-tab.active{color:var(--text);border-bottom-color:var(--accent);}
.profile-tab-icon{font-size:15px;}

.profile-pane{display:none;}
.profile-pane.active{display:block;}

.profile-hero{display:flex;align-items:center;gap:16px;padding:20px 22px;background:var(--panel2);border:1px solid var(--border);border-radius:12px;margin-bottom:20px;}
.profile-hero-icon{width:52px;height:52px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;}
.profile-hero-name{font-family:'Fraunces',serif;font-size:18px;font-weight:600;letter-spacing:-0.3px;}
.profile-hero-desc{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.5;}
.profile-hero-count{margin-left:auto;text-align:center;flex-shrink:0;}
.profile-hero-count-num{font-family:'Fraunces',serif;font-size:26px;font-weight:600;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;}
.profile-hero-count-label{font-size:10px;color:var(--muted);margin-top:2px;letter-spacing:0.5px;}

.perm-sections{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.perm-section{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:18px 20px;}
.perm-section-title{font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.perm-section-title::after{content:'';flex:1;height:1px;background:var(--border);}
.perm-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid rgba(30,45,69,0.6);}
.perm-row:last-child{border-bottom:none;}
.perm-label{font-size:12px;font-weight:500;color:var(--text);}
.perm-sub{font-size:10px;color:var(--muted);margin-top:2px;}
.perm-always{font-size:11px;font-weight:600;color:var(--accent);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.72);z-index:2000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.25s;backdrop-filter:blur(4px);}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:28px 32px;width:500px;max-width:95vw;transform:translateY(18px);transition:transform 0.25s;max-height:90vh;overflow-y:auto;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal h2{font-family:'Fraunces',serif;font-size:21px;font-weight:400;letter-spacing:-0.5px;margin-bottom:4px;}
.modal-sub{color:var(--muted);font-size:13px;margin-bottom:22px;}
.modal-form-group{margin-bottom:14px;}
.modal-label{display:block;font-size:10px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;}
.modal-input,.modal-select,.modal-textarea{width:100%;padding:9px 13px;background:var(--panel2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Inter',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;}
.modal-input:focus,.modal-select:focus,.modal-textarea:focus{border-color:var(--accent);}
.modal-select option{background:var(--panel2);}
.modal-textarea{resize:vertical;min-height:76px;}
.modal-row{display:flex;gap:12px;}
.modal-row .modal-form-group{flex:1;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);}
.modal-divider{height:1px;background:var(--border);margin:16px 0;}
.modal-section-label{font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.perm-toggle-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(30,45,69,0.5);}
.perm-toggle-row:last-child{border-bottom:none;}
.perm-toggle-label{font-size:13px;}
.perm-toggle-sub{font-size:11px;color:var(--muted);}

/* ‚ïê‚ïê‚ïê VIEW: REGISTROS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#view-records { flex-direction:column; overflow:hidden; }

.records-toolbar {
  display:flex; align-items:center; gap:10px; padding:16px 28px;
  background:var(--panel); border-bottom:1px solid var(--border);
  flex-shrink:0; flex-wrap:wrap;
}
.records-search { flex:1; min-width:200px; position:relative; }
.records-search svg { position:absolute; left:10px; top:50%; transform:translateY(-50%); width:14px; height:14px; color:var(--muted); pointer-events:none; }
.records-search input { width:100%; padding:8px 12px 8px 32px; background:var(--panel2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:'Inter',sans-serif; font-size:13px; outline:none; transition:border-color 0.2s; }
.records-search input:focus { border-color:var(--accent); }
.records-search input::placeholder { color:var(--muted); }
.records-filter-select { padding:8px 12px; background:var(--panel2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:'Inter',sans-serif; font-size:13px; outline:none; cursor:pointer; }
.records-filter-select:focus { border-color:var(--accent); }
.records-filter-select option { background:var(--panel2); }

.records-body { flex:1; display:flex; overflow:hidden; }

/* LISTA ESQUERDA */
.records-list-col { width:380px; flex-shrink:0; overflow-y:auto; border-right:1px solid var(--border); background:var(--panel); }
.records-list-col::-webkit-scrollbar { width:3px; }
.records-list-col::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

.rec-list-header { padding:14px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
.rec-list-count { font-size:11px; font-weight:600; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }

.rec-item { padding:16px 20px; border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.15s; }
.rec-item:hover { background:var(--panel2); }
.rec-item.active { background:rgba(0,212,170,0.06); border-left:3px solid var(--accent); padding-left:17px; }
.rec-item-header { display:flex; align-items:flex-start; justify-content:space-between; gap:8px; margin-bottom:6px; }
.rec-item-city { font-family:'Fraunces',serif; font-size:15px; font-weight:600; letter-spacing:-0.2px; }
.rec-item-date { font-size:10px; color:var(--muted); white-space:nowrap; margin-top:3px; }
.rec-item-meta { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.rec-item-state { font-size:10px; font-weight:600; padding:2px 7px; border-radius:5px; background:var(--panel2); border:1px solid var(--border); color:var(--muted); }
.rec-item-user { font-size:11px; color:var(--muted); }
.rec-demand-pill { display:inline-flex; align-items:center; gap:3px; font-size:10px; font-weight:600; padding:2px 7px; border-radius:10px; margin-top:5px; }
.dp-open   { background:rgba(255,107,53,0.12); color:var(--warn);   border:1px solid rgba(255,107,53,0.3); }
.dp-solved { background:rgba(0,212,170,0.10); color:var(--accent); border:1px solid rgba(0,212,170,0.25); }
.dp-pend   { background:rgba(168,85,247,0.12); color:#c084fc;       border:1px solid rgba(168,85,247,0.3); }

/* DETALHE DIREITA */
.records-detail-col { flex:1; overflow-y:auto; padding:32px 36px; background:var(--bg); }
.records-detail-col::-webkit-scrollbar { width:4px; }
.records-detail-col::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

.rec-empty { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--muted); gap:12px; }
.rec-empty-icon { font-size:48px; opacity:0.3; }
.rec-empty-text { font-size:14px; }

/* DETALHE HEADER */
.rec-detail-hero { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:24px 28px; margin-bottom:20px; }
.rec-detail-eyebrow { font-size:9px; font-weight:600; letter-spacing:2px; text-transform:uppercase; color:var(--accent); margin-bottom:8px; }
.rec-detail-title { font-family:'Fraunces',serif; font-size:26px; font-weight:400; letter-spacing:-0.5px; margin-bottom:4px; }
.rec-detail-sub { font-size:13px; color:var(--muted); margin-bottom:18px; }
.rec-detail-chips { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.rec-detail-chip { display:inline-flex; align-items:center; gap:5px; padding:4px 12px; border-radius:20px; font-size:11px; font-weight:500; }
.chip-result-visited { background:rgba(0,136,255,0.12); color:#60a5fa; border:1px solid rgba(0,136,255,0.25); }
.chip-result-pending  { background:rgba(255,107,53,0.12);  color:var(--warn); border:1px solid rgba(255,107,53,0.25); }
.chip-result-ok       { background:rgba(0,212,170,0.12);   color:var(--accent); border:1px solid rgba(0,212,170,0.25); }
.chip-user { background:var(--panel2); color:var(--text); border:1px solid var(--border); }
.chip-date { background:var(--panel2); color:var(--muted); border:1px solid var(--border); }

/* SECTIONS */
.rec-sections { display:flex; flex-direction:column; gap:16px; }
.rec-section { background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
.rec-section-header { display:flex; align-items:center; gap:10px; padding:16px 20px; border-bottom:1px solid var(--border); }
.rec-section-icon { width:32px; height:32px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; }
.rec-section-title { font-family:'Fraunces',serif; font-size:15px; font-weight:600; letter-spacing:-0.2px; }
.rec-section-count { margin-left:auto; font-size:11px; font-weight:600; padding:2px 8px; border-radius:10px; background:var(--panel2); border:1px solid var(--border); color:var(--muted); }
.rec-section-body { padding:16px 20px; display:flex; flex-direction:column; gap:10px; }

/* TEMAS */
.tema-chip { display:inline-flex; align-items:center; gap:5px; padding:5px 12px; border-radius:20px; font-size:12px; font-weight:500; background:var(--panel2); border:1px solid var(--border); color:var(--text); margin:3px; }

/* DEMANDAS */
.demanda-card { background:var(--panel2); border:1px solid var(--border); border-radius:10px; padding:14px 16px; }
.demanda-card-header { display:flex; align-items:flex-start; gap:10px; margin-bottom:8px; }
.demanda-status-icon { width:20px; height:20px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:11px; flex-shrink:0; margin-top:1px; }
.dem-solved { background:rgba(0,212,170,0.15); color:var(--accent); border:1px solid rgba(0,212,170,0.3); }
.dem-open   { background:rgba(255,107,53,0.12); color:var(--warn);   border:1px solid rgba(255,107,53,0.25); }
.dem-dep    { background:rgba(168,85,247,0.12); color:#c084fc;       border:1px solid rgba(168,85,247,0.25); }
.demanda-text { font-size:13px; line-height:1.5; flex:1; }
.demanda-dep { display:flex; align-items:center; gap:6px; margin-top:8px; padding:8px 12px; background:rgba(168,85,247,0.06); border:1px solid rgba(168,85,247,0.2); border-radius:8px; }
.demanda-dep-label { font-size:10px; font-weight:600; letter-spacing:1px; text-transform:uppercase; color:#c084fc; }
.demanda-dep-value { font-size:12px; color:var(--text); }

/* OBSERVA√á√ïES */
.obs-text { font-size:13px; line-height:1.7; color:var(--text); white-space:pre-wrap; }

/* AI RESUMO */
.ai-resumo-box { background:linear-gradient(135deg,rgba(0,212,170,0.05),rgba(0,136,255,0.05)); border:1px solid rgba(0,212,170,0.2); border-radius:14px; padding:20px 22px; }
.ai-resumo-header { display:flex; align-items:center; gap:10px; margin-bottom:14px; }
.ai-resumo-icon { width:32px; height:32px; background:linear-gradient(135deg,var(--accent),var(--accent2)); border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0; }
.ai-resumo-title { font-family:'Fraunces',serif; font-size:15px; font-weight:600; }
.ai-resumo-badge { margin-left:auto; font-size:9px; font-weight:600; letter-spacing:1.5px; text-transform:uppercase; padding:3px 9px; border-radius:6px; background:rgba(0,212,170,0.12); color:var(--accent); border:1px solid rgba(0,212,170,0.25); }
.ai-resumo-text { font-size:13px; line-height:1.7; color:var(--text); white-space:pre-wrap; }
.ai-resumo-text.loading { color:var(--muted); font-style:italic; }
.ai-resumo-actions { display:flex; gap:8px; margin-top:14px; }
.ai-locked { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; gap:8px; color:var(--muted); text-align:center; }
.ai-locked-icon { font-size:28px; opacity:0.4; }
.ai-locked-text { font-size:12px; }

/* MODAL VISITA EXPANDIDO */
.visit-modal-body { display:flex; flex-direction:column; gap:0; }
.visit-section { margin-bottom:20px; }
.visit-section-title { font-size:10px; font-weight:600; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid var(--border); }

/* temas tags input */
.tags-input-wrap { display:flex; flex-wrap:wrap; gap:6px; padding:8px 10px; background:var(--panel2); border:1px solid var(--border); border-radius:8px; min-height:42px; align-items:center; cursor:text; }
.tags-input-wrap:focus-within { border-color:var(--accent); }
.tag-item { display:inline-flex; align-items:center; gap:4px; padding:3px 9px; background:var(--panel3); border:1px solid var(--border2); border-radius:20px; font-size:12px; color:var(--text); }
.tag-remove { cursor:pointer; color:var(--muted); font-size:14px; line-height:1; }
.tag-remove:hover { color:var(--danger); }
.tags-input { border:none; outline:none; background:transparent; color:var(--text); font-family:'Inter',sans-serif; font-size:13px; min-width:120px; flex:1; }
.tags-input::placeholder { color:var(--muted); }

/* demandas no modal */
.demanda-modal-list { display:flex; flex-direction:column; gap:8px; }
.demanda-modal-item { background:var(--panel2); border:1px solid var(--border); border-radius:10px; padding:12px 14px; }
.demanda-modal-item-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.demanda-modal-item-header select { font-size:11px; padding:3px 8px; border-radius:6px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-family:'Inter',sans-serif; outline:none; cursor:pointer; }
.demanda-modal-item-header button { margin-left:auto; }
.demanda-dep-row { display:flex; gap:6px; margin-top:6px; align-items:center; }
.demanda-dep-row select, .demanda-dep-row input { flex:1; padding:6px 10px; font-size:12px; border:1px solid var(--border); border-radius:7px; background:var(--panel); color:var(--text); font-family:'Inter',sans-serif; outline:none; }
.demanda-dep-row select:focus, .demanda-dep-row input:focus { border-color:var(--accent); }
.add-demanda-btn { display:flex; align-items:center; gap:6px; padding:8px 14px; border:1px dashed var(--border2); border-radius:9px; background:transparent; color:var(--muted); font-family:'Inter',sans-serif; font-size:12px; cursor:pointer; width:100%; transition:all 0.2s; }
.add-demanda-btn:hover { border-color:var(--accent); color:var(--accent); }

/* ‚îÄ‚îÄ RASCUNHO BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.draft-banner {
  display:none; align-items:center; gap:12px;
  padding:10px 20px; background:rgba(255,193,7,0.08);
  border-bottom:1px solid rgba(255,193,7,0.25);
  font-size:12px; color:#f59e0b; flex-shrink:0;
}
.draft-banner.visible { display:flex; }
.draft-banner strong { font-weight:600; color:#fbbf24; }
.draft-banner-actions { display:flex; gap:6px; margin-left:auto; }
.btn-draft { padding:4px 12px; border-radius:6px; border:1px solid rgba(255,193,7,0.35);
  background:rgba(255,193,7,0.1); color:#fbbf24; font-size:11px; font-weight:600;
  cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.18s; }
.btn-draft:hover { background:rgba(255,193,7,0.2); }

/* badge rascunho na lista de registros */
.draft-badge {
  display:inline-flex; align-items:center; gap:3px;
  padding:2px 7px; border-radius:10px; font-size:10px; font-weight:600;
  background:rgba(255,193,7,0.12); color:#fbbf24;
  border:1px solid rgba(255,193,7,0.3); margin-left:4px;
}

/* modal footer com bot√£o rascunho */
.visit-modal-footer {
  display:flex; align-items:center; justify-content:space-between;
  padding-top:16px; border-top:1px solid var(--border); margin-top:4px; gap:10px;
}
.visit-modal-footer-left { display:flex; align-items:center; gap:8px; }
.visit-modal-footer-right { display:flex; gap:8px; }

/* ‚îÄ‚îÄ PAINEL NOTIFICA√á√ïES (settings) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.notif-channel-card {
  background:var(--panel2); border:1px solid var(--border);
  border-radius:14px; overflow:hidden;
}
.notif-channel-header {
  display:flex; align-items:center; gap:14px; padding:18px 22px;
  border-bottom:1px solid var(--border);
}
.notif-channel-logo {
  width:42px; height:42px; border-radius:12px;
  display:flex; align-items:center; justify-content:center; font-size:22px; flex-shrink:0;
}
.notif-channel-name { font-family:'Fraunces',serif; font-size:16px; font-weight:600; }
.notif-channel-desc { font-size:12px; color:var(--muted); margin-top:2px; }
.notif-channel-body { padding:20px 22px; display:flex; flex-direction:column; gap:14px; }
.notif-field { display:flex; flex-direction:column; gap:6px; }
.notif-field-label { font-size:10px; font-weight:600; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); }
.notif-field-hint { font-size:11px; color:var(--muted); margin-top:3px; line-height:1.5; }
.notif-input { width:100%; padding:9px 13px; background:var(--panel); border:1px solid var(--border);
  border-radius:8px; color:var(--text); font-family:'Inter',sans-serif; font-size:13px; outline:none;
  transition:border-color 0.2s; }
.notif-input:focus { border-color:var(--accent); }
.notif-input::placeholder { color:var(--muted); }
.notif-input-mono { font-family:'JetBrains Mono','Fira Code',monospace; font-size:12px; }
.notif-status { display:inline-flex; align-items:center; gap:6px; padding:5px 12px; border-radius:8px;
  font-size:12px; font-weight:500; }
.notif-status.ok  { background:rgba(0,212,170,0.1); color:var(--accent); border:1px solid rgba(0,212,170,0.25); }
.notif-status.err { background:rgba(239,68,68,0.1); color:var(--danger); border:1px solid rgba(239,68,68,0.2); }
.notif-status.off { background:var(--panel3); color:var(--muted); border:1px solid var(--border); }

.recipients-list { display:flex; flex-direction:column; gap:8px; }
.recipient-row { display:flex; align-items:center; gap:10px; padding:10px 14px;
  background:var(--panel); border:1px solid var(--border); border-radius:10px; }
.recipient-avatar { width:32px; height:32px; border-radius:9px;
  display:flex; align-items:center; justify-content:center;
  font-family:'Fraunces',serif; font-size:13px; font-weight:600; flex-shrink:0; }
.recipient-info { flex:1; min-width:0; }
.recipient-name { font-size:13px; font-weight:500; }
.recipient-role { font-size:11px; color:var(--muted); margin-top:1px; }
.recipient-remove { cursor:pointer; color:var(--muted); font-size:18px; transition:color 0.15s; padding:2px; }
.recipient-remove:hover { color:var(--danger); }
.add-recipient-row { display:flex; gap:8px; align-items:center; }
.add-recipient-select { flex:1; padding:8px 12px; background:var(--panel); border:1px solid var(--border);
  border-radius:8px; color:var(--text); font-family:'Inter',sans-serif; font-size:13px; outline:none; cursor:pointer; }
.add-recipient-select:focus { border-color:var(--accent); }
.add-recipient-select option { background:var(--panel2); }

.test-webhook-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.notif-channels-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
@media(max-width:900px){ .notif-channels-grid { grid-template-columns:1fr; } }

.notif-global-section { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:20px 22px; }
.notif-global-title { font-family:'Fraunces',serif; font-size:16px; font-weight:600; margin-bottom:4px; }
.notif-global-desc { font-size:12px; color:var(--muted); margin-bottom:18px; }

code.notif-var {
  display:inline-block; padding:2px 8px; border-radius:6px;
  background:var(--panel2); border:1px solid var(--border2);
  font-size:11px; color:var(--accent); font-family:monospace; cursor:pointer;
}
code.notif-var:hover { background:var(--panel3); border-color:var(--accent); }


#login-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9000;}
#login-screen.hidden{display:none;}
.login-card{background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:44px;width:380px;display:flex;flex-direction:column;gap:20px;box-shadow:0 24px 80px rgba(0,0,0,0.55);}
.login-logo{display:flex;align-items:center;gap:12px;margin-bottom:4px;}
.login-logo-mark{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;}
.login-title{font-family:'Fraunces',serif;font-size:22px;font-weight:600;letter-spacing:-0.5px;}
.login-sub{font-size:13px;color:var(--muted);margin-top:2px;}
.login-field{display:flex;flex-direction:column;gap:7px;}
.login-label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.login-input{padding:11px 14px;background:var(--panel2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'Inter',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s;}
.login-input:focus{border-color:var(--accent);}
.login-input::placeholder{color:var(--muted);}
.login-btn{width:100%;padding:13px;border-radius:10px;border:none;cursor:pointer;font-family:'Inter',sans-serif;font-size:14px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;transition:opacity 0.2s;margin-top:4px;}
.login-btn:hover{opacity:0.88;}
.login-btn:disabled{opacity:0.45;cursor:not-allowed;}
.login-err{font-size:12px;color:var(--danger);text-align:center;padding:9px 14px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;display:none;}
.login-err.visible{display:block;}
#app-loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:8000;gap:16px;}
#app-loading.hidden{display:none;}
.loading-spinner{width:40px;height:40px;border-radius:50%;border:3px solid var(--border2);border-top-color:var(--accent);animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{font-size:13px;color:var(--muted);}
.header-user{display:flex;align-items:center;gap:10px;padding:5px 5px 5px 12px;background:var(--panel2);border:1px solid var(--border);border-radius:30px;cursor:pointer;transition:border-color 0.2s;}
.header-user:hover{border-color:var(--accent);}
.header-user-name{font-size:12px;font-weight:500;}
.header-user-role{font-size:10px;color:var(--muted);}
.header-user-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Fraunces',serif;font-size:12px;font-weight:600;color:#fff;}
.sync-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;background:var(--muted);transition:background 0.4s;}
.sync-dot.syncing{background:#f59e0b;animation:pulse 1s infinite;}
.sync-dot.synced{background:var(--accent);}
.sync-dot.error{background:var(--danger);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}

</style>
</head>
<body>
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-mark">üìç</div>
      <div><div class="login-title">VisitaFiliais</div><div class="login-sub">Sistema de Gest√£o de Visitas</div></div>
    </div>
    <div class="login-field">
      <label class="login-label">E-mail</label>
      <input class="login-input" type="email" id="loginEmail" placeholder="seu@email.com" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <div class="login-field">
      <label class="login-label">Senha</label>
      <input class="login-input" type="password" id="loginPass" placeholder="Sua senha" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <div class="login-err" id="loginErr"></div>
    <button class="login-btn" id="loginBtn" onclick="doLogin()">Entrar</button>
  </div>
</div>
<div id="app-loading" class="hidden">
  <div class="loading-spinner"></div>
  <div class="loading-text" id="loadingText">Carregando sistema...</div>
</div>
<div id="app-body" style="display:none;flex:1;flex-direction:column;height:100vh;overflow:hidden;">
<header>
  <div class="logo">
    <div class="logo-mark">üìç</div>
    <div><h1>VisitaFiliais</h1><span>Sistema de Gest√£o de Visitas</span></div>
  </div>
  <div class="header-center">
    <button class="nav-tab active" id="tab-map" onclick="showView('map')">üó∫ Mapa</button>
    <button class="nav-tab" id="tab-records" onclick="showView('records')">üìã Registros</button>
    <button class="nav-tab" id="tab-settings" onclick="showView('settings')">‚öô Configura√ß√µes</button>
  </div>
  <div class="header-stats">
    <div class="stat"><div class="stat-num" id="totalCount">0</div><div class="stat-label">Filiais</div></div>
    <div class="stat"><div class="stat-num" id="visitedCount">0</div><div class="stat-label">Visitadas</div></div>
    <div class="stat"><div class="stat-num" id="pendingCount">0</div><div class="stat-label">Pendentes</div></div>
  </div>
  <div class="header-actions" style="display:flex;align-items:center;gap:10px;">
        <div style="display:flex;align-items:center;gap:6px;">
          <div class="sync-dot" id="syncDot"></div>
          <span id="syncLabel" style="font-size:10px;color:var(--muted);"></span>
        </div>
        <div class="header-user" onclick="doLogout()" title="Sair">
          <div style="text-align:right;">
            <div class="header-user-name" id="headerUserName">‚Äî</div>
            <div class="header-user-role" id="headerUserRole">‚Äî</div>
          </div>
          <div class="header-user-avatar" id="headerUserAvatar" style="background:#6b7a99;">?</div>
        </div>
    <button class="btn btn-ghost" onclick="openVisitModal()">+ Registrar Visita</button>
    <button class="btn btn-primary" onclick="openVisitModal()">Nova Visita</button>
  </div>
</header>

<div class="main">

  <!-- ‚ïê‚ïê‚ïê VIEW: MAPA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="view active" id="view-map">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-inner">
        <div class="sidebar-header"><div class="sidebar-title">Filiais</div></div>
        <div class="search-wrap">
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" id="searchInput" placeholder="Buscar cidade..." oninput="filterFiliais()"/>
          </div>
        </div>
        <div class="filter-tabs">
          <button class="filter-tab active" onclick="setFilter('all',this)">Todas</button>
          <button class="filter-tab" onclick="setFilter('ok',this)">Regulares</button>
          <button class="filter-tab" onclick="setFilter('visited',this)">Visitadas</button>
          <button class="filter-tab" onclick="setFilter('pending',this)">Pendentes</button>
        </div>
        <div class="filiais-list" id="filiaisList"></div>
      </div>
    </div>
    <div class="map-container">
      <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        <span class="toggle-icon">‚óÄ</span>
      </button>
      <div id="map"></div>
      <div class="map-filters">
        <div class="map-filter-group">
          <div class="map-filter-title">Status</div>
          <div class="map-filter-chips">
            <button class="map-chip active-status-all" onclick="setMapStatus('all',this)">Todas</button>
            <button class="map-chip" onclick="setMapStatus('ok',this)">Regular</button>
            <button class="map-chip" onclick="setMapStatus('visited',this)">Visitadas</button>
            <button class="map-chip" onclick="setMapStatus('pending',this)">Pendentes</button>
          </div>
        </div>
        <div class="map-filter-group">
          <div class="map-filter-title">Estado (UF)</div>
          <div class="map-filter-chips" id="ufChips"></div>
          <div class="chip-clear" id="clearUf" onclick="clearUfFilter()">‚úï Limpar filtro</div>
        </div>
      </div>
      <div class="map-legend" id="mapLegend">
        <div class="legend-title">Legenda</div>
        <div class="legend-item"><div class="legend-dot" id="leg-ok" style="background:var(--accent)"></div><span id="leg-ok-label">Regular</span></div>
        <div class="legend-item"><div class="legend-dot" id="leg-visited" style="background:var(--accent2)"></div><span id="leg-visited-label">Visitada</span></div>
        <div class="legend-item"><div class="legend-dot" id="leg-pending" style="background:var(--warn)"></div><span id="leg-pending-label">Pendente</span></div>
      </div>
    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê VIEW: REGISTROS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="view" id="view-records">

    <!-- RASCUNHO BANNER -->
    <div class="draft-banner" id="draftBanner">
      <span>üìù <strong>Rascunho salvo</strong> ‚Äî Voc√™ tem um rascunho em andamento. <span id="draftBannerInfo" style="color:var(--muted);"></span></span>
      <div class="draft-banner-actions">
        <button class="btn-draft" onclick="resumeDraft()">‚úè Continuar editando</button>
        <button class="btn-draft" style="border-color:rgba(239,68,68,0.4);color:#f87171;background:rgba(239,68,68,0.08);" onclick="discardDraft()">‚úï Descartar</button>
      </div>
    </div>
    <!-- TOOLBAR -->
    <div class="records-toolbar">
      <div class="records-search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="recSearch" placeholder="Buscar por cidade, respons√°vel, tema..." oninput="renderRecordsList()"/>
      </div>
      <select class="records-filter-select" id="recFilterUF" onchange="renderRecordsList()">
        <option value="">Todos os estados</option>
        <option value="PB">PB</option><option value="CE">CE</option><option value="PE">PE</option>
        <option value="RN">RN</option><option value="MA">MA</option><option value="AL">AL</option>
        <option value="RJ">RJ</option><option value="SP">SP</option>
      </select>
      <select class="records-filter-select" id="recFilterResult" onchange="renderRecordsList()">
        <option value="">Todos os resultados</option>
        <option value="visited">Visita realizada</option>
        <option value="pending">Pendente retorno</option>
        <option value="ok">Em acompanhamento</option>
      </select>
      <select class="records-filter-select" id="recFilterDemanda" onchange="renderRecordsList()">
        <option value="">Todas as demandas</option>
        <option value="open">Com demanda aberta</option>
        <option value="solved">Demandas resolvidas</option>
        <option value="dep">Aguardando terceiros</option>
      </select>
      <button class="btn btn-primary btn-sm" onclick="openVisitModal()">+ Nova Visita</button>
    </div>

    <!-- BODY -->
    <div class="records-body">
      <!-- LISTA -->
      <div class="records-list-col">
        <div class="rec-list-header">
          <span class="rec-list-count" id="recListCount">0 registros</span>
        </div>
        <div id="recListItems"></div>
      </div>
      <!-- DETALHE -->
      <div class="records-detail-col" id="recDetail">
        <div class="rec-empty">
          <div class="rec-empty-icon">üìã</div>
          <div class="rec-empty-text">Selecione um registro para ver os detalhes</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê VIEW: CONFIGURA√á√ïES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="view" id="view-settings">

    <nav class="settings-nav">
      <div class="settings-nav-section">Geral</div>
      <button class="settings-nav-item active" onclick="showPanel('filiais',this)"><span class="nav-icon">üè¢</span> Filiais</button>
      <button class="settings-nav-item" onclick="showPanel('status',this)"><span class="nav-icon">üéØ</span> Status</button>
      <button class="settings-nav-item" onclick="showPanel('display',this)"><span class="nav-icon">üó∫</span> Exibi√ß√£o</button>
      <div class="settings-nav-section">Notifica√ß√µes</div>
      <button class="settings-nav-item" onclick="showPanel('notif',this)"><span class="nav-icon">üîî</span> Envio Autom√°tico</button>
      <div class="settings-nav-section">Acesso</div>
      <button class="settings-nav-item" onclick="showPanel('users',this)"><span class="nav-icon">üë•</span> Usu√°rios</button>
      <button class="settings-nav-item" onclick="showPanel('profiles',this)"><span class="nav-icon">üîê</span> Perfis &amp; Permiss√µes</button>
    </nav>

    <div class="settings-content">

      <!-- PAINEL: FILIAIS -->
      <div class="settings-panel active" id="panel-filiais">
        <div class="settings-scroll">
          <div class="settings-section">
            <div class="settings-section-header">
              <div><div class="settings-section-title">Filiais Cadastradas</div><div class="settings-section-desc">Gerencie todas as filiais do sistema</div></div>
              <button class="btn btn-primary btn-sm" onclick="showAddRow()">+ Nova Filial</button>
            </div>
            <div class="settings-section-body" style="padding:0;">
              <div class="filiais-table-wrap"><table class="filiais-table">
                <thead><tr><th>Cidade</th><th>UF</th><th>Coordenadas</th><th>Status</th><th style="text-align:right">A√ß√µes</th></tr></thead>
                <tbody id="filiaisTableBody"></tbody>
              </table></div>
            </div>
            <div class="add-filial-form" id="addFilialForm" style="display:none;">
              <div class="form-field"><label>Cidade</label><input class="form-input" id="newCity" placeholder="Ex: Campina Grande"/></div>
              <div class="form-field"><label>UF</label><input class="form-input" id="newState" placeholder="PB" maxlength="2" style="text-transform:uppercase"/></div>
              <div class="form-field"><label>Lat, Lng (opcional)</label><input class="form-input" id="newCoords" placeholder="-7.23, -35.88"/></div>
              <button class="btn btn-primary" onclick="addFilial()">Adicionar</button>
            </div>
          </div>
        </div>
        <div class="settings-save-bar"><span class="save-hint">Filiais s√£o aplicadas imediatamente ao mapa.</span></div>
      </div>

      <!-- PAINEL: STATUS -->
      <div class="settings-panel" id="panel-status">
        <div class="settings-scroll">
          <div class="settings-section">
            <div class="settings-section-header"><div><div class="settings-section-title">Defini√ß√£o de Status</div><div class="settings-section-desc">Configure o que cada status significa e como √© exibido</div></div></div>
            <div class="settings-section-body">
              <div class="status-config-grid">
                <div class="status-card">
                  <div class="status-card-header"><div class="status-dot-big" id="conf-ok-dot" style="background:#00d4aa"></div><div><div class="status-card-title">Regular</div><div class="status-card-subtitle">Filial sem visita registrada</div></div></div>
                  <div class="config-row"><div class="config-label">Nome do status</div><input class="config-input" id="conf-ok-name" value="Regular" oninput="previewConfig()"/></div>
                  <div class="config-row"><div class="config-label">Cor do marcador</div><div class="color-row"><input type="color" class="color-input" id="conf-ok-color" value="#00d4aa" oninput="previewConfig()"/><input class="config-input" id="conf-ok-hex" value="#00d4aa" oninput="syncColor('ok')" style="flex:1"/></div></div>
                </div>
                <div class="status-card">
                  <div class="status-card-header"><div class="status-dot-big" id="conf-visited-dot" style="background:#0088ff"></div><div><div class="status-card-title">Visitada</div><div class="status-card-subtitle">Visita registrada recentemente</div></div></div>
                  <div class="config-row"><div class="config-label">Nome do status</div><input class="config-input" id="conf-visited-name" value="Visitada" oninput="previewConfig()"/></div>
                  <div class="config-row"><div class="config-label">Validade (dias)</div><input type="number" class="config-input" id="conf-visited-days" value="30" min="1" max="365"/></div>
                  <div class="config-row"><div class="config-label">Cor do marcador</div><div class="color-row"><input type="color" class="color-input" id="conf-visited-color" value="#0088ff" oninput="previewConfig()"/><input class="config-input" id="conf-visited-hex" value="#0088ff" oninput="syncColor('visited')" style="flex:1"/></div></div>
                </div>
                <div class="status-card">
                  <div class="status-card-header"><div class="status-dot-big" id="conf-pending-dot" style="background:#ff6b35"></div><div><div class="status-card-title">Pendente</div><div class="status-card-subtitle">Visita vencida ou agendada</div></div></div>
                  <div class="config-row"><div class="config-label">Nome do status</div><input class="config-input" id="conf-pending-name" value="Pendente" oninput="previewConfig()"/></div>
                  <div class="config-row"><div class="config-label">Vence ap√≥s (dias)</div><input type="number" class="config-input" id="conf-pending-days" value="60" min="1" max="365"/></div>
                  <div class="config-row"><div class="config-label">Cor do marcador</div><div class="color-row"><input type="color" class="color-input" id="conf-pending-color" value="#ff6b35" oninput="previewConfig()"/><input class="config-input" id="conf-pending-hex" value="#ff6b35" oninput="syncColor('pending')" style="flex:1"/></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-save-bar">
          <span class="save-hint">Mudan√ßas refletem no mapa imediatamente.</span>
          <div style="display:flex;gap:10px;"><button class="btn btn-ghost" onclick="resetConfig()">Restaurar padr√µes</button><button class="btn btn-primary" onclick="saveConfig()">Salvar</button></div>
        </div>
      </div>

      <!-- PAINEL: EXIBI√á√ÉO -->
      <div class="settings-panel" id="panel-display">
        <div class="settings-scroll">
          <div class="settings-section">
            <div class="settings-section-header"><div><div class="settings-section-title">Exibi√ß√£o do Mapa</div><div class="settings-section-desc">Controle o que aparece no mapa e na interface</div></div></div>
            <div class="settings-section-body">
              <div class="display-grid">
                <div class="toggle-row"><div><div class="toggle-label">Legenda do mapa</div><div class="toggle-sub">Exibir painel de legenda</div></div><label class="toggle-switch"><input type="checkbox" id="tog-legend" checked onchange="applyDisplaySettings()"><span class="toggle-slider"></span></label></div>
                <div class="toggle-row"><div><div class="toggle-label">Filtros no mapa</div><div class="toggle-sub">Painel de filtros flutuante</div></div><label class="toggle-switch"><input type="checkbox" id="tog-filters" checked onchange="applyDisplaySettings()"><span class="toggle-slider"></span></label></div>
                <div class="toggle-row"><div><div class="toggle-label">Sidebar expandida</div><div class="toggle-sub">Abrir com menu vis√≠vel</div></div><label class="toggle-switch"><input type="checkbox" id="tog-sidebar" checked onchange="applyDisplaySettings()"><span class="toggle-slider"></span></label></div>
                <div class="toggle-row"><div><div class="toggle-label">Zoom autom√°tico por UF</div><div class="toggle-sub">Focar estado ao filtrar</div></div><label class="toggle-switch"><input type="checkbox" id="tog-autozoom" checked onchange="applyDisplaySettings()"><span class="toggle-slider"></span></label></div>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-save-bar"><span class="save-hint">Altera√ß√µes de exibi√ß√£o s√£o aplicadas imediatamente.</span></div>
      </div>

      <!-- PAINEL: USU√ÅRIOS -->
      <div class="settings-panel" id="panel-users">
        <div class="settings-scroll">

          <!-- Sum√°rio por perfil -->
          <div class="users-summary" id="usersSummary"></div>

          <div class="settings-section">
            <div class="settings-section-header">
              <div><div class="settings-section-title">Usu√°rios do Sistema</div><div class="settings-section-desc">Gerencie acessos e perfis de cada usu√°rio</div></div>
              <button class="btn btn-primary btn-sm" onclick="openUserModal(null)">+ Novo Usu√°rio</button>
            </div>
            <div class="settings-section-body">
              <!-- Toolbar: busca + filtro por perfil -->
              <div class="users-toolbar">
                <div class="users-search">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                  <input type="text" id="usersSearchInput" placeholder="Buscar por nome ou e-mail..." oninput="renderUsersGrid()"/>
                </div>
                <button class="role-filter-chip active" id="chip-all" onclick="setUserRoleFilter('all',this)">Todos</button>
                <button class="role-filter-chip" id="chip-admin"   onclick="setUserRoleFilter('admin',this)">üëë Admin</button>
                <button class="role-filter-chip" id="chip-diretor" onclick="setUserRoleFilter('diretor',this)">üéñ Diretor</button>
                <button class="role-filter-chip" id="chip-gerente" onclick="setUserRoleFilter('gerente',this)">üìã Gerente</button>
                <button class="role-filter-chip" id="chip-coord"   onclick="setUserRoleFilter('coord',this)">üìå Coord.</button>
              </div>
              <!-- Tabela de usu√°rios -->
              <div class="users-table-wrap">
                <table class="users-table">
                  <thead>
                    <tr>
                      <th>Usu√°rio</th>
                      <th>Perfil</th>
                      <th>Status</th>
                      <th>√öltimo acesso</th>
                      <th style="text-align:right">A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-save-bar">
          <span class="save-hint">Usu√°rios inativos n√£o conseguem acessar o sistema.</span>
        </div>
      </div>

      <!-- PAINEL: PERFIS & PERMISS√ïES -->
      <div class="settings-panel" id="panel-profiles">
        <div class="settings-scroll">
          <div class="settings-section">
            <div class="settings-section-header">
              <div>
                <div class="settings-section-title">Perfis &amp; Permiss√µes</div>
                <div class="settings-section-desc">Defina o que cada perfil pode visualizar e executar no sistema</div>
              </div>
            </div>
            <div class="settings-section-body">
              <!-- Abas por perfil -->
              <div class="profiles-tabs" id="profilesTabs"></div>
              <!-- Painel de cada perfil gerado por JS -->
              <div id="profilesContent"></div>
            </div>
          </div>
        </div>
        <div class="settings-save-bar">
          <span class="save-hint">Permiss√µes do Administrador s√£o fixas. Os demais perfis s√£o configur√°veis.</span>
          <button class="btn btn-primary" onclick="saveProfiles()">Salvar permiss√µes</button>
        </div>
      </div>


      <!-- PAINEL: NOTIFICA√á√ïES / ENVIO AUTOM√ÅTICO -->
      <div class="settings-panel" id="panel-notif">
        <div class="settings-scroll">

          <!-- AVISO GLOBAL -->
          <div class="notif-global-section">
            <div class="notif-global-title">üì° Envio autom√°tico de relat√≥rios</div>
            <div class="notif-global-desc">
              Quando ativado, cada relat√≥rio de visita <strong>salvo definitivamente</strong> ser√° disparado automaticamente
              para os destinat√°rios configurados ‚Äî sem que o autor do relat√≥rio saiba.
              Rascunhos <em>nunca</em> s√£o enviados.
            </div>
            <div class="toggle-row" style="max-width:420px;">
              <div>
                <div class="toggle-label">Ativar envio autom√°tico</div>
                <div class="toggle-sub">Habilita disparos para WhatsApp e Telegram ao salvar</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="notifGlobalEnabled" onchange="saveNotifConfig()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>

          <!-- DESTINAT√ÅRIOS -->
          <div class="settings-section">
            <div class="settings-section-header">
              <div>
                <div class="settings-section-title">Destinat√°rios</div>
                <div class="settings-section-desc">Usu√°rios que receber√£o notifica√ß√£o autom√°tica de cada novo relat√≥rio salvo</div>
              </div>
            </div>
            <div class="settings-section-body">
              <div class="recipients-list" id="recipientsList"></div>
              <div class="add-recipient-row" style="margin-top:12px;">
                <select class="add-recipient-select" id="recipientUserSelect">
                  <option value="">Selecionar usu√°rio para adicionar...</option>
                </select>
                <button class="btn btn-ghost btn-sm" onclick="addRecipient()">+ Adicionar</button>
              </div>
            </div>
          </div>

          <!-- CANAIS -->
          <div class="notif-channels-grid">

            <!-- WHATSAPP -->
            <div class="notif-channel-card">
              <div class="notif-channel-header">
                <div class="notif-channel-logo" style="background:rgba(37,211,102,0.12);">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                </div>
                <div>
                  <div class="notif-channel-name">WhatsApp</div>
                  <div class="notif-channel-desc">Via Evolution API, Z-API ou WAHA webhook</div>
                </div>
                <div style="margin-left:auto;">
                  <label class="toggle-switch">
                    <input type="checkbox" id="waEnabled" onchange="saveNotifConfig()">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
              <div class="notif-channel-body">
                <div class="notif-field">
                  <div class="notif-field-label">URL do Webhook</div>
                  <input class="notif-input notif-input-mono" id="waWebhookUrl"
                    placeholder="https://sua-api.com/webhook/whatsapp"
                    oninput="saveNotifConfig()"/>
                  <div class="notif-field-hint">Endpoint que receber√° o payload JSON com os dados do relat√≥rio.</div>
                </div>
                <div class="notif-field">
                  <div class="notif-field-label">Token de autoriza√ß√£o (opcional)</div>
                  <input class="notif-input notif-input-mono" id="waToken" type="password"
                    placeholder="Bearer token ou API key"
                    oninput="saveNotifConfig()"/>
                </div>
                <div class="notif-field">
                  <div class="notif-field-label">N√∫mero/Grupo destino (opcional)</div>
                  <input class="notif-input" id="waTarget"
                    placeholder="5583999999999 ou ID do grupo"
                    oninput="saveNotifConfig()"/>
                  <div class="notif-field-hint">Deixe em branco se o webhook j√° define o destino.</div>
                </div>
                <div class="test-webhook-row">
                  <button class="btn btn-ghost btn-sm" onclick="testWebhook('wa')">üîå Testar conex√£o</button>
                  <span id="waTestStatus" class="notif-status off" style="display:none;"></span>
                </div>
              </div>
            </div>

            <!-- TELEGRAM -->
            <div class="notif-channel-card">
              <div class="notif-channel-header">
                <div class="notif-channel-logo" style="background:rgba(0,136,204,0.12);">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="#0088cc"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                </div>
                <div>
                  <div class="notif-channel-name">Telegram</div>
                  <div class="notif-channel-desc">Via Bot API com chat_id configurado</div>
                </div>
                <div style="margin-left:auto;">
                  <label class="toggle-switch">
                    <input type="checkbox" id="tgEnabled" onchange="saveNotifConfig()">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
              <div class="notif-channel-body">
                <div class="notif-field">
                  <div class="notif-field-label">Bot Token</div>
                  <input class="notif-input notif-input-mono" id="tgBotToken" type="password"
                    placeholder="123456789:ABCdefGHI..."
                    oninput="saveNotifConfig()"/>
                  <div class="notif-field-hint">Token fornecido pelo @BotFather ao criar o bot.</div>
                </div>
                <div class="notif-field">
                  <div class="notif-field-label">Chat ID</div>
                  <input class="notif-input notif-input-mono" id="tgChatId"
                    placeholder="-1001234567890 (grupo) ou 123456 (pessoal)"
                    oninput="saveNotifConfig()"/>
                  <div class="notif-field-hint">ID do chat ou grupo que receber√° as mensagens. Use grupos negativos para canais.</div>
                </div>
                <div class="notif-field">
                  <div class="notif-field-label">Webhook personalizado (opcional)</div>
                  <input class="notif-input notif-input-mono" id="tgWebhookUrl"
                    placeholder="https://api.telegram.org/bot{TOKEN}/sendMessage"
                    oninput="saveNotifConfig()"/>
                  <div class="notif-field-hint">Deixe em branco para usar o endpoint padr√£o da Telegram Bot API.</div>
                </div>
                <div class="test-webhook-row">
                  <button class="btn btn-ghost btn-sm" onclick="testWebhook('tg')">üîå Testar conex√£o</button>
                  <span id="tgTestStatus" class="notif-status off" style="display:none;"></span>
                </div>
              </div>
            </div>

          </div><!-- /notif-channels-grid -->

          <!-- TEMPLATE DA MENSAGEM -->
          <div class="settings-section">
            <div class="settings-section-header">
              <div>
                <div class="settings-section-title">Modelo da mensagem</div>
                <div class="settings-section-desc">Personalize o texto enviado. Use vari√°veis entre colchetes.</div>
              </div>
              <button class="btn btn-ghost btn-sm" onclick="resetMsgTemplate()">Restaurar padr√£o</button>
            </div>
            <div class="settings-section-body">
              <textarea class="notif-input" id="notifMsgTemplate" rows="9" style="font-family:monospace;font-size:12px;line-height:1.6;resize:vertical;" oninput="saveNotifConfig()"></textarea>
              <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;">
                <span style="font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);width:100%;margin-bottom:4px;">Vari√°veis dispon√≠veis</span>
                <code class="notif-var">{filial}</code><code class="notif-var">{uf}</code>
                <code class="notif-var">{data}</code><code class="notif-var">{responsavel}</code>
                <code class="notif-var">{resultado}</code><code class="notif-var">{temas}</code>
                <code class="notif-var">{total_demandas}</code><code class="notif-var">{demandas_abertas}</code>
                <code class="notif-var">{observacoes}</code>
              </div>
            </div>
          </div>

        </div>
        <div class="settings-save-bar">
          <span class="save-hint">Configura√ß√µes salvas automaticamente. O autor do relat√≥rio n√£o recebe qualquer aviso sobre envios.</span>
          <button class="btn btn-primary" onclick="saveNotifConfig(); showToast('Configura√ß√µes de notifica√ß√£o salvas!')">Salvar configura√ß√µes</button>
        </div>
      </div>

    </div>
  </div>

</div><!-- /main -->

<!-- MODAL: VISITA (expandido) -->
<div class="modal-overlay" id="visitModalOverlay" onclick="if(event.target===this)closeVisitModal()">
  <div class="modal" style="width:640px;max-height:88vh;overflow-y:auto;">
    <input type="hidden" id="visitEditId"/>
    <h2 id="visitModalTitle">Registrar Visita</h2>
    <p class="modal-sub" id="visitModalSub">Preencha todos os dados da visita</p>

    <!-- BLOCO 1: Identifica√ß√£o -->
    <div class="visit-section">
      <div class="visit-section-title">Identifica√ß√£o</div>
      <div class="modal-row">
        <div class="modal-form-group" style="flex:2"><label class="modal-label">Filial</label><select class="modal-select" id="filialSelect"></select></div>
        <div class="modal-form-group"><label class="modal-label">Data</label><input type="date" class="modal-input" id="visitDate"/></div>
      </div>
      <div class="modal-row">
        <div class="modal-form-group" style="flex:2"><label class="modal-label">Respons√°vel pela visita</label><input type="text" class="modal-input" id="visitResponsavel" placeholder="Nome do visitante"/></div>
        <div class="modal-form-group"><label class="modal-label">Resultado geral</label>
          <select class="modal-select" id="visitResult">
            <option value="visited">‚úÖ Visita realizada</option>
            <option value="pending">‚è≥ Pendente retorno</option>
            <option value="ok">üëÅ Em acompanhamento</option>
          </select>
        </div>
      </div>
    </div>

    <!-- BLOCO 2: Temas abordados -->
    <div class="visit-section">
      <div class="visit-section-title">Temas abordados</div>
      <div class="tags-input-wrap" id="temasWrap" onclick="document.getElementById('temasInput').focus()">
        <input class="tags-input" id="temasInput" placeholder="Digite um tema e pressione Enter..." onkeydown="handleTagInput(event)"/>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:5px;">Ex: Estoque, Atendimento ao cliente, Treinamento, Metas</div>
    </div>

    <!-- BLOCO 3: Demandas -->
    <div class="visit-section">
      <div class="visit-section-title">Demandas</div>
      <div class="demanda-modal-list" id="demandasList"></div>
      <button class="add-demanda-btn" onclick="addDemandaItem()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Adicionar demanda
      </button>
    </div>

    <!-- BLOCO 4: Observa√ß√µes gerais -->
    <div class="visit-section">
      <div class="visit-section-title">Observa√ß√µes gerais</div>
      <textarea class="modal-textarea" id="visitObs" placeholder="Descreva os pontos observados, decis√µes tomadas, pr√≥ximos passos..." style="min-height:100px;"></textarea>
    </div>

    <div class="visit-modal-footer">
      <div class="visit-modal-footer-left">
        <button class="btn btn-ghost" onclick="closeVisitModal()">Cancelar</button>
      </div>
      <div class="visit-modal-footer-right">
        <button class="btn-draft" style="padding:7px 16px;border-radius:8px;font-size:13px;" onclick="saveAsDraft()" id="btnSaveDraft">
          üìù Salvar rascunho
        </button>
        <button class="btn btn-primary" onclick="saveVisit()">Enviar relat√≥rio</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: EDITAR FILIAL -->
<div class="modal-overlay" id="editModalOverlay" onclick="if(event.target===this)closeEditModal()">
  <div class="modal">
    <h2>Editar Filial</h2><p class="modal-sub">Atualize as informa√ß√µes da filial</p>
    <input type="hidden" id="editIdx"/>
    <div class="modal-row">
      <div class="modal-form-group" style="flex:2"><label class="modal-label">Cidade</label><input type="text" class="modal-input" id="editCity"/></div>
      <div class="modal-form-group"><label class="modal-label">UF</label><input type="text" class="modal-input" id="editState" maxlength="2" style="text-transform:uppercase"/></div>
    </div>
    <div class="modal-row">
      <div class="modal-form-group"><label class="modal-label">Latitude</label><input type="number" class="modal-input" id="editLat" step="0.0001"/></div>
      <div class="modal-form-group"><label class="modal-label">Longitude</label><input type="number" class="modal-input" id="editLng" step="0.0001"/></div>
    </div>
    <div class="modal-form-group"><label class="modal-label">Status</label>
      <select class="modal-select" id="editStatus"><option value="ok">Regular</option><option value="visited">Visitada</option><option value="pending">Pendente</option></select>
    </div>
    <div class="modal-actions"><button class="btn btn-ghost" onclick="closeEditModal()">Cancelar</button><button class="btn btn-primary" onclick="saveEdit()">Salvar</button></div>
  </div>
</div>

<!-- MODAL: USU√ÅRIO -->
<div class="modal-overlay" id="userModalOverlay" onclick="if(event.target===this)closeUserModal()">
  <div class="modal" style="width:540px;">
    <h2 id="userModalTitle">Novo Usu√°rio</h2>
    <p class="modal-sub" id="userModalSub">Preencha os dados do novo usu√°rio</p>
    <input type="hidden" id="userId"/>

    <div class="modal-row">
      <div class="modal-form-group" style="flex:2">
        <label class="modal-label">Nome completo</label>
        <input type="text" class="modal-input" id="userName" placeholder="Ex: Maria Souza"/>
      </div>
      <div class="modal-form-group">
        <label class="modal-label">Telefone</label>
        <input type="text" class="modal-input" id="userPhone" placeholder="(83) 9 9999-9999"/>
      </div>
    </div>

    <div class="modal-row">
      <div class="modal-form-group" style="flex:2">
        <label class="modal-label">E-mail</label>
        <input type="email" class="modal-input" id="userEmail" placeholder="usuario@empresa.com"/>
      </div>
      <div class="modal-form-group">
        <label class="modal-label">UF de atua√ß√£o</label>
        <select class="modal-select" id="userUF">
          <option value="">Todas</option>
          <option value="PB">PB</option><option value="CE">CE</option>
          <option value="PE">PE</option><option value="RN">RN</option>
          <option value="MA">MA</option><option value="AL">AL</option>
          <option value="RJ">RJ</option><option value="SP">SP</option>
        </select>
      </div>
    </div>

    <div class="modal-row">
      <div class="modal-form-group">
        <label class="modal-label">Perfil de acesso</label>
        <select class="modal-select" id="userRole" onchange="updateRolePreview()">
          <option value="admin">üëë Administrador</option>
          <option value="diretor">üéñ Diretor</option>
          <option value="gerente">üìã Gerente</option>
          <option value="coord" selected>üìå Coordenador</option>
        </select>
      </div>
      <div class="modal-form-group">
        <label class="modal-label">Status</label>
        <select class="modal-select" id="userActive">
          <option value="true">‚úÖ Ativo</option>
          <option value="false">‚è∏ Inativo</option>
        </select>
      </div>
    </div>

    <!-- Preview do perfil -->
    <div id="rolePreview" style="background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:12px 16px;margin-bottom:14px;font-size:12px;color:var(--muted);line-height:1.6;"></div>

    <div id="userPassGroup">
      <div class="modal-divider"></div>
      <div class="modal-section-label">Credenciais de acesso</div>
      <div class="modal-row">
        <div class="modal-form-group">
          <label class="modal-label">Senha provis√≥ria</label>
          <input type="password" class="modal-input" id="userPass" placeholder="M√≠nimo 8 caracteres"/>
        </div>
        <div class="modal-form-group">
          <label class="modal-label">Confirmar senha</label>
          <input type="password" class="modal-input" id="userPassConfirm" placeholder="Repita a senha"/>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeUserModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveUser()">Salvar Usu√°rio</button>
    </div>
  </div>
</div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  SUBSTITUA PELOS DADOS DO SEU PROJETO FIREBASE           ‚ïë
// ‚ïë  Console ‚Üí ‚öô Configura√ß√µes ‚Üí Seus apps ‚Üí </>            ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyCxPFx-VRppt9YA_Gssg9eLCEuWoSPhuGo",
  authDomain:        "mia-visitas.firebaseapp.com",
  projectId:         "mia-visitas",
  storageBucket:     "mia-visitas.firebasestorage.app",
  messagingSenderId: "745373188746",
  appId:             "1:745373188746:web:954bf576c821b90b266373"
};

// ‚îÄ‚îÄ Firebase init (protegido) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let auth, db;
try {
  firebase.initializeApp(FIREBASE_CONFIG);
  auth = firebase.auth();
  db   = firebase.firestore();
  db.enablePersistence({ synchronizeTabs: true }).catch(() => {});
} catch(e) {
  console.error('Firebase init error:', e);
  const errEl = document.getElementById('loginErr');
  if (errEl) { errEl.textContent = 'Erro de config Firebase: ' + e.message; errEl.classList.add('visible'); }
}

// ‚îÄ‚îÄ Estado global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let FILIAIS  = [];
let USERS    = [];
let PROFILES = {};
let CONFIG   = {
  ok:      { name:'Regular',  color:'#00d4aa', days:null },
  visited: { name:'Visitada', color:'#0088ff', days:30   },
  pending: { name:'Pendente', color:'#ff6b35', days:60   },
  display: { legend:true, filters:true, sidebar:true, autozoom:true }
};
let NOTIF_CONFIG = {
  globalEnabled:false, recipients:[],
  wa:{ enabled:false, webhookUrl:'', token:'', target:'' },
  tg:{ enabled:false, botToken:'', chatId:'', webhookUrl:'' },
  msgTemplate:''
};

const DEPARTAMENTOS = [
  'Comercial','Financeiro','Log√≠stica','RH','TI','Jur√≠dico',
  'Marketing','Opera√ß√µes','Qualidade','Diretoria','Suporte'
];

let CURRENT_USER      = null;
let activeRecordId    = null;
let visitTags         = [];
let visitDemandasModal= [];
let activeFilter      = 'all';
let activeFilialIndex = null;
let markers           = [];
let mapStatusFilter   = 'all';
let mapUfFilter       = null;
let map;
let demandaIdCounter  = 0;
let nextUserId        = 1;

// ‚îÄ‚îÄ Sync indicator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSyncState(state, label) {
  label = label || '';
  const dot = document.getElementById('syncDot');
  const lbl = document.getElementById('syncLabel');
  if (dot) dot.className = 'sync-dot ' + state;
  if (lbl) lbl.textContent = label;
}

// ‚îÄ‚îÄ Login / Logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogin() {
  if (!auth) {
    const e = document.getElementById('loginErr');
    e.textContent = 'Firebase n√£o inicializado. Verifique as credenciais.';
    e.classList.add('visible');
    return;
  }
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPass').value;
  const btn   = document.getElementById('loginBtn');
  const err   = document.getElementById('loginErr');
  err.classList.remove('visible');
  btn.disabled = true;
  btn.textContent = 'Entrando...';
  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch(e) {
    const msgs = {
      'auth/user-not-found':     'Usu√°rio n√£o encontrado.',
      'auth/wrong-password':     'Senha incorreta.',
      'auth/invalid-email':      'E-mail inv√°lido.',
      'auth/too-many-requests':  'Muitas tentativas. Tente mais tarde.',
      'auth/invalid-credential': 'E-mail ou senha incorretos.',
    };
    err.textContent = msgs[e.code] || ('Erro: ' + e.message);
    err.classList.add('visible');
    btn.disabled = false;
    btn.textContent = 'Entrar';
  }
}

async function doLogout() {
  if (!confirm('Sair do sistema?')) return;
  if (auth) await auth.signOut();
}

// ‚îÄ‚îÄ Auth observer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (auth) {
  auth.onAuthStateChanged(async function(fbUser) {
    if (!fbUser) {
      document.getElementById('app-loading').classList.add('hidden');
      document.getElementById('app-body').style.display = 'none';
      document.getElementById('login-screen').classList.remove('hidden');
      var btn = document.getElementById('loginBtn');
      if (btn) { btn.disabled = false; btn.textContent = 'Entrar'; }
      return;
    }
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app-loading').classList.remove('hidden');
    try {
      var snap = await db.collection('users').doc(fbUser.uid).get();
      if (!snap.exists || snap.data().active === false) {
        await auth.signOut();
        return;
      }
      CURRENT_USER = { uid: fbUser.uid };
      var data = snap.data();
      Object.keys(data).forEach(function(k) { CURRENT_USER[k] = data[k]; });
      await bootApp();
    } catch(e) {
      document.getElementById('app-loading').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      var err = document.getElementById('loginErr');
      err.textContent = 'Erro ao carregar perfil: ' + e.message;
      err.classList.add('visible');
      var btn = document.getElementById('loginBtn');
      if (btn) { btn.disabled = false; btn.textContent = 'Entrar'; }
    }
  });
}

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function bootApp() {
  document.getElementById('loadingText').textContent = 'Carregando dados...';
  setSyncState('syncing', 'Carregando...');
  try {
    await Promise.all([
      loadFiliais(), loadUsers(), loadProfiles(), loadConfig(), loadVisitas()
    ]);
    setupRealtimeListeners();
    document.getElementById('app-loading').classList.add('hidden');
    document.getElementById('app-body').style.display = 'flex';
    setSyncState('synced', 'Sincronizado');
    updateHeaderUser();
    initMap();
    rebuildMarkers();
    buildUfChips();
    renderList();
    updateStats();
    await loadNotifConfig();
    await checkDraftBanner();
  } catch(e) {
    setSyncState('error', 'Erro');
    document.getElementById('loadingText').innerHTML =
      'Erro ao carregar: ' + e.message +
      '<br><br><button onclick="location.reload()" style="margin-top:12px;padding:8px 20px;' +
      'border-radius:8px;border:1px solid var(--danger);background:transparent;' +
      'color:var(--danger);cursor:pointer;font-size:13px;">Recarregar</button>';
    console.error('Boot error:', e);
  }
}

function updateHeaderUser() {
  if (!CURRENT_USER) return;
  var el = document.getElementById('headerUserName');
  if (el) el.textContent = CURRENT_USER.name || CURRENT_USER.email || '';
  var meta = (ROLE_META && ROLE_META[CURRENT_USER.role]) || {};
  var roleEl = document.getElementById('headerUserRole');
  if (roleEl) roleEl.textContent = (meta.icon || '') + ' ' + (meta.label || CURRENT_USER.role || '');
  var av = document.getElementById('headerUserAvatar');
  if (av) {
    av.textContent = getInitials(CURRENT_USER.name || CURRENT_USER.email || '?');
    av.style.background = meta.bg || '#6b7a99';
  }
}

// ‚îÄ‚îÄ Loaders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFiliais() {
  var snap = await db.collection('filiais').orderBy('state').orderBy('city').get();
  FILIAIS = snap.docs.map(function(d) { return Object.assign({ id: d.id }, d.data()); });
}
async function loadUsers() {
  var snap = await db.collection('users').get();
  USERS = snap.docs.map(function(d) { return Object.assign({ id: d.id }, d.data()); });
}
async function loadProfiles() {
  var snap = await db.collection('profiles').get();
  PROFILES = {};
  snap.docs.forEach(function(d) { PROFILES[d.id] = d.data(); });
}
async function loadConfig() {
  var snap = await db.collection('config').doc('global').get();
  if (!snap.exists) return;
  var d = snap.data();
  if (d.ok_name)      CONFIG.ok.name      = d.ok_name;
  if (d.ok_color)     CONFIG.ok.color     = d.ok_color;
  if (d.visited_name)  CONFIG.visited.name  = d.visited_name;
  if (d.visited_color) CONFIG.visited.color = d.visited_color;
  if (d.visited_days)  CONFIG.visited.days  = d.visited_days;
  if (d.pending_name)  CONFIG.pending.name  = d.pending_name;
  if (d.pending_color) CONFIG.pending.color = d.pending_color;
  if (d.pending_days)  CONFIG.pending.days  = d.pending_days;
}
async function loadVisitas() {
  var q = db.collection('visitas').orderBy('criadoEm', 'desc');
  if (CURRENT_USER.role === 'coord') q = q.where('autorUid', '==', CURRENT_USER.uid);
  var snap = await q.limit(300).get();
  VISITS = snap.docs.map(function(d) {
    var v = Object.assign({ id: d.id }, d.data());
    v.filialIdx = FILIAIS.findIndex(function(f) { return f.id === v.filialId; });
    return v;
  });
}
async function loadNotifConfig() {
  try {
    var snap = await db.collection('notif_config').doc('global').get();
    if (snap.exists) {
      var d = snap.data();
      NOTIF_CONFIG.globalEnabled = d.globalEnabled || false;
      NOTIF_CONFIG.recipients    = d.recipients    || [];
      NOTIF_CONFIG.wa  = { enabled:d.wa_enabled||false, webhookUrl:d.wa_webhookUrl||'', token:d.wa_token||'', target:d.wa_target||'' };
      NOTIF_CONFIG.tg  = { enabled:d.tg_enabled||false, botToken:d.tg_botToken||'', chatId:d.tg_chatId||'', webhookUrl:d.tg_webhookUrl||'' };
      NOTIF_CONFIG.msgTemplate = d.msgTemplate || '';
    }
  } catch(e) {}
  if (typeof applyNotifConfigToUI === 'function') applyNotifConfigToUI();
}

// ‚îÄ‚îÄ Realtime listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupRealtimeListeners() {
  db.collection('filiais').onSnapshot(function(snap) {
    snap.docChanges().forEach(function(c) {
      var item = Object.assign({ id: c.doc.id }, c.doc.data());
      if (c.type === 'added' || c.type === 'modified') {
        var i = FILIAIS.findIndex(function(f) { return f.id === item.id; });
        if (i >= 0) FILIAIS[i] = item; else FILIAIS.push(item);
      } else {
        FILIAIS = FILIAIS.filter(function(f) { return f.id !== item.id; });
      }
    });
    rebuildMarkers(); renderList(); updateStats();
    var fp = document.getElementById('panel-filiais');
    if (fp && fp.classList.contains('active')) renderFilialTable();
    setSyncState('synced', 'Sincronizado');
  });

  var vq = db.collection('visitas').orderBy('criadoEm', 'desc').limit(300);
  if (CURRENT_USER.role === 'coord') vq = vq.where('autorUid', '==', CURRENT_USER.uid);
  vq.onSnapshot(function(snap) {
    snap.docChanges().forEach(function(c) {
      var raw = Object.assign({ id: c.doc.id }, c.doc.data());
      raw.filialIdx = FILIAIS.findIndex(function(f) { return f.id === raw.filialId; });
      if (c.type === 'added' || c.type === 'modified') {
        var i = VISITS.findIndex(function(v) { return v.id === raw.id; });
        if (i >= 0) VISITS[i] = raw; else VISITS.unshift(raw);
      } else {
        VISITS = VISITS.filter(function(v) { return v.id !== raw.id; });
        if (activeRecordId === raw.id) {
          activeRecordId = null;
          var el = document.getElementById('recDetail');
          if (el) el.innerHTML = '<div class="rec-empty"><div class="rec-empty-icon">üìã</div><div class="rec-empty-text">Registro removido.</div></div>';
        }
      }
    });
    renderRecordsList(); updateStats(); setSyncState('synced', 'Sincronizado');
  });

  db.collection('users').onSnapshot(function(snap) {
    snap.docChanges().forEach(function(c) {
      var item = Object.assign({ id: c.doc.id }, c.doc.data());
      if (c.type === 'added' || c.type === 'modified') {
        var i = USERS.findIndex(function(u) { return u.id === item.id; });
        if (i >= 0) USERS[i] = item; else USERS.push(item);
      } else {
        USERS = USERS.filter(function(u) { return u.id !== item.id; });
      }
    });
  });
}

// ‚îÄ‚îÄ Opera√ß√µes Firestore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveVisit() {
  var filialIdx = parseInt(document.getElementById('filialSelect').value);
  var date      = document.getElementById('visitDate').value;
  var resp      = document.getElementById('visitResponsavel').value.trim();
  var result    = document.getElementById('visitResult').value;
  var obs       = document.getElementById('visitObs').value.trim();
  var editId    = document.getElementById('visitEditId').value;
  if (!resp || !date) { showToast('Preencha respons√°vel e data.', 'warn'); return; }
  var filial = FILIAIS[filialIdx] || {};
  var demandas = visitDemandasModal.map(function(d) {
    return {
      text:     (document.getElementById('dem-text-'     +d.id)||{}).value||'',
      status:   (document.getElementById('dem-status-'   +d.id)||{}).value||'open',
      depTipo:  (document.getElementById('dem-dep-tipo-' +d.id)||{}).value||null,
      depValor: (document.getElementById('dem-dep-valor-'+d.id)||{}).value||null,
    };
  }).filter(function(d) { return d.text.trim(); });
  setSyncState('syncing', 'Salvando...');
  try {
    var payload = {
      filialId: filial.id||'', filialCity: filial.city||'', filialState: filial.state||'',
      date: date, responsavel: resp, result: result,
      temas: visitTags.slice(), demandas: demandas, obs: obs,
      autorUid: CURRENT_USER.uid, autorName: CURRENT_USER.name||'',
      atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
    };
    var savedId;
    if (editId) {
      await db.collection('visitas').doc(editId).update(payload);
      savedId = editId;
    } else {
      payload.criadoEm = firebase.firestore.FieldValue.serverTimestamp();
      var ref = await db.collection('visitas').add(payload);
      savedId = ref.id;
    }
    if (filial.id) {
      await db.collection('filiais').doc(filial.id).update({
        status: result, atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    closeVisitModal();
    await clearDraftFromStorage();
    await checkDraftBanner();
    setSyncState('synced', 'Sincronizado');
    showToast('‚úì Relat√≥rio salvo!');
    activeRecordId = savedId;
    renderRecordsList();
    fireNotifications(Object.assign({}, payload, { id: savedId, filialIdx: filialIdx }));
  } catch(e) { setSyncState('error', 'Erro'); showToast('Erro: ' + e.message, 'err'); }
}

async function addFilial() {
  var city   = document.getElementById('newCity').value.trim();
  var state  = document.getElementById('newState').value.trim().toUpperCase();
  var coords = document.getElementById('newCoords').value.trim();
  if (!city || !state) { showToast('Preencha cidade e UF.', 'warn'); return; }
  var lat = -8.5, lng = -38.5;
  if (coords) { var p = coords.split(','); lat = parseFloat(p[0])||lat; lng = parseFloat(p[1])||lng; }
  setSyncState('syncing', '');
  try {
    await db.collection('filiais').add({ city:city, state:state, lat:lat, lng:lng, status:'ok',
      criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
      atualizadoEm: firebase.firestore.FieldValue.serverTimestamp() });
    ['newCity','newState','newCoords'].forEach(function(id) { document.getElementById(id).value=''; });
    document.getElementById('addFilialForm').style.display='none';
    setSyncState('synced','Sincronizado'); showToast('Filial adicionada!');
  } catch(e) { setSyncState('error','Erro'); showToast('Erro: '+e.message,'err'); }
}
async function saveEdit() {
  var idx = parseInt(document.getElementById('editIdx').value);
  var filial = FILIAIS[idx]; if (!filial) return;
  setSyncState('syncing','');
  try {
    await db.collection('filiais').doc(filial.id).update({
      city:   document.getElementById('editCity').value.trim(),
      state:  document.getElementById('editState').value.trim().toUpperCase(),
      lat:    parseFloat(document.getElementById('editLat').value),
      lng:    parseFloat(document.getElementById('editLng').value),
      status: document.getElementById('editStatus').value,
      atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
    });
    closeEditModal(); setSyncState('synced','Sincronizado'); showToast('Filial atualizada!');
  } catch(e) { setSyncState('error','Erro'); showToast('Erro: '+e.message,'err'); }
}
async function deleteFilial(idx) {
  var f = FILIAIS[idx];
  if (!f || !confirm('Excluir '+f.city+'?')) return;
  try { await db.collection('filiais').doc(f.id).delete(); showToast('Filial removida.'); }
  catch(e) { showToast('Erro: '+e.message,'err'); }
}
async function saveUser() {
  var name   = document.getElementById('userName').value.trim();
  var email  = document.getElementById('userEmail').value.trim();
  var role   = document.getElementById('userRole').value;
  var active = document.getElementById('userActive').value === 'true';
  var editId = document.getElementById('userId').value;
  if (!name || !email) { showToast('Preencha nome e e-mail.','warn'); return; }
  if (!editId) {
    showToast('Crie o usu√°rio em Firebase Console ‚Üí Authentication. Depois edite aqui.','warn');
    closeUserModal(); return;
  }
  try {
    await db.collection('users').doc(editId).update({ name:name, email:email, role:role, active:active,
      atualizadoEm: firebase.firestore.FieldValue.serverTimestamp() });
    closeUserModal(); showToast('Usu√°rio atualizado!');
  } catch(e) { showToast('Erro: '+e.message,'err'); }
}
async function deleteUser(userId) {
  if (!confirm('Desativar este usu√°rio?')) return;
  try { await db.collection('users').doc(userId).update({ active:false,
    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp() }); showToast('Usu√°rio desativado.'); }
  catch(e) { showToast('Erro: '+e.message,'err'); }
}
async function saveConfig() {
  CONFIG.ok.name        = document.getElementById('conf-ok-name').value;
  CONFIG.ok.color       = document.getElementById('conf-ok-color').value;
  CONFIG.visited.name   = document.getElementById('conf-visited-name').value;
  CONFIG.visited.color  = document.getElementById('conf-visited-color').value;
  CONFIG.visited.days   = parseInt(document.getElementById('conf-visited-days').value)||30;
  CONFIG.pending.name   = document.getElementById('conf-pending-name').value;
  CONFIG.pending.color  = document.getElementById('conf-pending-color').value;
  CONFIG.pending.days   = parseInt(document.getElementById('conf-pending-days').value)||60;
  try {
    await db.collection('config').doc('global').set({
      ok_name:CONFIG.ok.name, ok_color:CONFIG.ok.color,
      visited_name:CONFIG.visited.name, visited_color:CONFIG.visited.color, visited_days:CONFIG.visited.days,
      pending_name:CONFIG.pending.name, pending_color:CONFIG.pending.color, pending_days:CONFIG.pending.days,
      atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
    });
    refreshMarkers(); updateLegend(); showToast('Configura√ß√µes salvas!');
  } catch(e) { showToast('Erro: '+e.message,'err'); }
}
function resetConfig() {
  ['ok','visited','pending'].forEach(function(k) {
    var map = {ok:['Regular','#00d4aa'],visited:['Visitada','#0088ff'],pending:['Pendente','#ff6b35']};
    document.getElementById('conf-'+k+'-name').value  = map[k][0];
    document.getElementById('conf-'+k+'-color').value = map[k][1];
    document.getElementById('conf-'+k+'-hex').value   = map[k][1];
  });
  document.getElementById('conf-visited-days').value = '30';
  document.getElementById('conf-pending-days').value = '60';
  previewConfig();
}
async function saveProfiles() {
  try {
    var batch = db.batch();
    Object.keys(PROFILES).forEach(function(role) {
      if (role === 'admin') return;
      batch.set(db.collection('profiles').doc(role), PROFILES[role]);
    });
    await batch.commit(); showToast('Permiss√µes salvas!');
  } catch(e) { showToast('Erro: '+e.message,'err'); }
}
async function deleteVisit(id) {
  if (!confirm('Excluir este registro?')) return;
  try { await db.collection('visitas').doc(id).delete(); showToast('Registro exclu√≠do.'); }
  catch(e) { showToast('Erro: '+e.message,'err'); }
}
async function saveNotifConfig() {
  var g = function(id) { return document.getElementById(id); };
  if (g('notifGlobalEnabled')) NOTIF_CONFIG.globalEnabled = g('notifGlobalEnabled').checked;
  if (g('waEnabled'))    NOTIF_CONFIG.wa.enabled    = g('waEnabled').checked;
  if (g('waWebhookUrl')) NOTIF_CONFIG.wa.webhookUrl = g('waWebhookUrl').value.trim();
  if (g('waToken'))      NOTIF_CONFIG.wa.token      = g('waToken').value.trim();
  if (g('waTarget'))     NOTIF_CONFIG.wa.target     = g('waTarget').value.trim();
  if (g('tgEnabled'))    NOTIF_CONFIG.tg.enabled    = g('tgEnabled').checked;
  if (g('tgBotToken'))   NOTIF_CONFIG.tg.botToken   = g('tgBotToken').value.trim();
  if (g('tgChatId'))     NOTIF_CONFIG.tg.chatId     = g('tgChatId').value.trim();
  if (g('tgWebhookUrl')) NOTIF_CONFIG.tg.webhookUrl = g('tgWebhookUrl').value.trim();
  if (g('notifMsgTemplate')) NOTIF_CONFIG.msgTemplate = g('notifMsgTemplate').value;
  try {
    await db.collection('notif_config').doc('global').set({
      globalEnabled:NOTIF_CONFIG.globalEnabled, recipients:NOTIF_CONFIG.recipients,
      wa_enabled:NOTIF_CONFIG.wa.enabled, wa_webhookUrl:NOTIF_CONFIG.wa.webhookUrl,
      wa_token:NOTIF_CONFIG.wa.token, wa_target:NOTIF_CONFIG.wa.target,
      tg_enabled:NOTIF_CONFIG.tg.enabled, tg_botToken:NOTIF_CONFIG.tg.botToken,
      tg_chatId:NOTIF_CONFIG.tg.chatId, tg_webhookUrl:NOTIF_CONFIG.tg.webhookUrl,
      msgTemplate:NOTIF_CONFIG.msgTemplate,
      atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch(e) {}
}

// ‚îÄ‚îÄ Rascunhos ‚Üí Firestore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getDraftKey() { return (CURRENT_USER && CURRENT_USER.uid) || 'anon'; }
async function saveDraftToStorage(data) {
  try { await db.collection('rascunhos').doc(getDraftKey()).set(
    Object.assign({}, data, { savedAt: firebase.firestore.FieldValue.serverTimestamp() })
  ); } catch(e) {}
}
async function loadDraftFromStorage() {
  try { var s = await db.collection('rascunhos').doc(getDraftKey()).get(); if (s.exists) return s.data(); } catch(e) {}
  return null;
}
async function clearDraftFromStorage() {
  try { await db.collection('rascunhos').doc(getDraftKey()).delete(); } catch(e) {}
}

// ‚îÄ‚îÄ Permiss√£o IA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function canUseAI() {
  var role = CURRENT_USER && CURRENT_USER.role;
  return !!(role && PROFILES[role] && PROFILES[role].ai_summary === true);
}

// ‚îÄ‚îÄ Mapa ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMap() {
  if (map) return;
  map = L.map('map', { center:[-8.5,-38.5], zoom:6, zoomControl:false, attributionControl:false });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  L.control.zoom({ position:'bottomleft' }).addTo(map);
  applyBrazilMask();
}

// ‚îÄ‚îÄ Navega√ß√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showView(view) {
  document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active','active-settings'); });
  document.getElementById('view-'+view).classList.add('active');
  var tab = document.getElementById('tab-'+view);
  if (tab) tab.classList.add(view==='settings' ? 'active-settings' : 'active');
  if (view==='map') setTimeout(function() { if (map) map.invalidateSize(); }, 50);
  if (view==='settings') renderFilialTable();
  if (view==='records')  renderRecordsList();
}
function showPanel(panel, btn) {
  document.querySelectorAll('.settings-panel').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.settings-nav-item').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById('panel-'+panel).classList.add('active');
  btn.classList.add('active');
  if (panel==='users')    renderUsersGrid();
  if (panel==='profiles') renderProfilesGrid();
  if (panel==='filiais')  renderFilialTable();
  if (panel==='notif')    applyNotifConfigToUI();
}

const STATE_BOUNDS = {
  PB:[[-8.35,-38.81],[-5.96,-34.79]], CE:[[-7.86,-41.44],[-2.78,-37.25]],
  PE:[[-9.49,-41.37],[-7.35,-34.84]], RN:[[-6.99,-38.58],[-4.82,-34.97]],
  MA:[[-10.27,-48.95],[-1.02,-41.81]], AL:[[-10.50,-38.24],[-8.81,-35.15]],
  RJ:[[-23.37,-44.89],[-20.76,-40.95]], SP:[[-25.31,-53.11],[-19.78,-44.16]],
};


const ROLE_META = {
  admin:   { label:'Administrador', cls:'role-admin',   bg:'#ef4444', icon:'üëë' },
  diretor: { label:'Diretor',       cls:'role-diretor', bg:'#a855f7', icon:'üéñ' },
  gerente: { label:'Gerente',       cls:'role-gerente', bg:'#0088ff', icon:'üìã' },
  coord:   { label:'Coordenador',   cls:'role-coord',   bg:'#00d4aa', icon:'üìå' },
};
let nextUserId = 7;


const PERM_GROUPS = [
  { group:'Visitas', perms:[
    { key:'visit_register', label:'Registrar visitas',     sub:'Criar novos registros de visita' },
    { key:'visit_view_own', label:'Ver pr√≥prias visitas',  sub:'Hist√≥rico das pr√≥prias visitas' },
    { key:'visit_view_all', label:'Ver todas as visitas',  sub:'Hist√≥rico de toda a equipe' },
    { key:'visit_edit',     label:'Editar visitas',        sub:'Alterar registros existentes' },
    { key:'visit_delete',   label:'Excluir visitas',       sub:'Remover registros do sistema' },
  ]},
  { group:'Filiais', perms:[
    { key:'filial_view',   label:'Visualizar filiais',  sub:'Ver o mapa e lista de filiais' },
    { key:'filial_add',    label:'Cadastrar filiais',   sub:'Adicionar novas filiais' },
    { key:'filial_edit',   label:'Editar filiais',      sub:'Alterar dados de filiais' },
    { key:'filial_delete', label:'Remover filiais',     sub:'Excluir filiais do sistema' },
  ]},
  { group:'Relat√≥rios', perms:[
    { key:'report_view',   label:'Visualizar relat√≥rios', sub:'Acessar dashboards e resumos' },
    { key:'report_export', label:'Exportar relat√≥rios',   sub:'Baixar dados em Excel/PDF' },
  ]},
  { group:'Sistema', perms:[
    { key:'user_manage',    label:'Gerenciar usu√°rios',    sub:'Criar, editar e remover usu√°rios' },
    { key:'config_manage',  label:'Acessar configura√ß√µes', sub:'Alterar configura√ß√µes do sistema' },
    { key:'profile_manage', label:'Gerenciar perfis',      sub:'Editar permiss√µes dos perfis' },
    { key:'ai_summary',     label:'Resumo por IA',         sub:'Gerar resumo executivo de visitas com IA' },
  ]},
];

// ‚ïê‚ïê‚ïê UI / MAPA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyBrazilMask() {
  const mapEl=document.getElementById('map');
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.style.cssText='position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:399;';
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  const maskEl=document.createElementNS('http://www.w3.org/2000/svg','mask');
  maskEl.id='brazilMask'; defs.appendChild(maskEl); svg.appendChild(defs); mapEl.appendChild(svg);
  function redraw(){
    const size=map.getSize(); svg.setAttribute('viewBox',`0 0 ${size.x} ${size.y}`);
    maskEl.innerHTML='';
    const bg=document.createElementNS('http://www.w3.org/2000/svg','rect');
    bg.setAttribute('x','0');bg.setAttribute('y','0');bg.setAttribute('width',size.x);bg.setAttribute('height',size.y);bg.setAttribute('fill','white');maskEl.appendChild(bg);
    BRAZIL_GEOJSON.features.forEach(f=>{
      f.geometry.coordinates.forEach(ring=>{
        const path=document.createElementNS('http://www.w3.org/2000/svg','path');
        let d=''; ring.forEach((coord,i)=>{const pt=map.latLngToContainerPoint(L.latLng(coord[1],coord[0]));d+=(i===0?`M${pt.x},${pt.y}`:`L${pt.x},${pt.y}`);});
        d+='Z';path.setAttribute('d',d);path.setAttribute('fill','black');maskEl.appendChild(path);
      });
    });
    const old=svg.querySelector('rect.overlay');if(old)old.remove();
    const overlay=document.createElementNS('http://www.w3.org/2000/svg','rect');
    overlay.setAttribute('class','overlay');overlay.setAttribute('x','0');overlay.setAttribute('y','0');overlay.setAttribute('width',size.x);overlay.setAttribute('height',size.y);overlay.setAttribute('fill','#0a0e1a');overlay.setAttribute('mask','url(#brazilMask)');svg.appendChild(overlay);
  }
  redraw(); map.on('move zoom resize',redraw);
}
applyBrazilMask();

// ‚ïê‚ïê‚ïê MARKERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getStatusColor(s){return CONFIG[s]?.color||'#6b7a99';}
function getStatusLabel(s){return CONFIG[s]?.name||s;}

function createMarkerIcon(status,active=false,dimmed=false){
  const color=dimmed?'#2a3550':getStatusColor(status);
  const shadow=dimmed?'none':`0 4px 15px ${getStatusColor(status)}66`;
  const opacity=dimmed?0.3:1; const size=active?36:28;
  return L.divIcon({html:`<div style="width:${size}px;height:${size}px;background:${color};border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:2px solid rgba(255,255,255,${dimmed?0.08:0.4});box-shadow:${shadow};opacity:${opacity};transition:all 0.2s;"></div>`,className:'',iconSize:[size,size],iconAnchor:[size/2,size]});
}

const STATE_NAMES={PB:'Para√≠ba',CE:'Cear√°',PE:'Pernambuco',RN:'Rio Grande do Norte',MA:'Maranh√£o',AL:'Alagoas',RJ:'Rio de Janeiro',SP:'S√£o Paulo'};

function buildPopup(f,idx){
  const color=getStatusColor(f.status);
  return `<div style="padding:18px 20px;min-width:220px;font-family:'Inter',sans-serif;color:#e8edf5;">
    <div style="font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:#00d4aa;margin-bottom:6px;">Filial ¬∑ ${f.state}</div>
    <div style="font-family:'Fraunces',serif;font-size:19px;font-weight:400;letter-spacing:-0.3px;margin-bottom:2px;">${f.city}</div>
    <div style="font-size:12px;color:#6b7a99;margin-bottom:14px;">${STATE_NAMES[f.state]||f.state}</div>
    <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:#1a2235;border-radius:8px;margin-bottom:12px;">
      <div style="width:8px;height:8px;border-radius:50%;background:${color};flex-shrink:0;"></div>
      <span style="font-size:12px;">${getStatusLabel(f.status)}</span>
    </div>
    <div style="display:flex;gap:8px;">
      <button onclick="openVisitModalForFilial(${idx})" style="flex:1;padding:8px;border-radius:7px;border:none;cursor:pointer;font-family:'Inter',sans-serif;font-size:12px;font-weight:500;background:linear-gradient(135deg,#00d4aa,#0088ff);color:#000;">+ Registrar Visita</button>
      <button style="flex:1;padding:8px;border-radius:7px;border:1px solid #1e2d45;cursor:pointer;font-family:'Inter',sans-serif;font-size:12px;font-weight:500;background:#1a2235;color:#e8edf5;">Hist√≥rico</button>
    </div>
  </div>`;
}

function isMarkerDimmed(f){return !((mapStatusFilter==='all'||f.status===mapStatusFilter)&&(!mapUfFilter||f.state===mapUfFilter));}

function refreshMarkers(){FILIAIS.forEach((f,idx)=>{if(markers[idx])markers[idx].setIcon(createMarkerIcon(f.status,idx===activeFilialIndex,isMarkerDimmed(f)));});}

function rebuildMarkers(){
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  FILIAIS.forEach((f,idx)=>{
    const m=L.marker([f.lat,f.lng],{icon:createMarkerIcon(f.status)}).addTo(map).bindPopup(buildPopup(f,idx),{maxWidth:280,closeButton:true});
    m.on('click',()=>setActiveFilial(idx)); markers.push(m);
  });
  const sel=document.getElementById('filialSelect'); sel.innerHTML='';
  FILIAIS.forEach((f,i)=>{const o=document.createElement('option');o.value=i;o.textContent=`${f.city} - ${f.state}`;sel.appendChild(o);});
}

function setActiveFilial(idx){
  if(activeFilialIndex!==null) markers[activeFilialIndex]?.setIcon(createMarkerIcon(FILIAIS[activeFilialIndex].status,false,isMarkerDimmed(FILIAIS[activeFilialIndex])));
  activeFilialIndex=idx; markers[idx]?.setIcon(createMarkerIcon(FILIAIS[idx].status,true,false));
  document.querySelectorAll('.filial-item').forEach(el=>el.classList.remove('active'));
  const el=document.getElementById(`filial-${idx}`);
  if(el){el.classList.add('active');el.scrollIntoView({behavior:'smooth',block:'nearest'});}
}

// ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  const icon=document.querySelector('#sidebarToggle .toggle-icon');
  const collapsed=sb.classList.toggle('collapsed');
  icon.style.transform=collapsed?'rotate(180deg)':'';
  setTimeout(()=>map.invalidateSize({animate:false}),320);
}

function renderList(){
  const search=document.getElementById('searchInput').value.toLowerCase();
  const list=document.getElementById('filiaisList'); list.innerHTML='';
  [...new Set(FILIAIS.map(f=>f.state))].forEach(state=>{
    const items=FILIAIS.map((f,i)=>({...f,idx:i}))
      .filter(f=>f.state===state)
      .filter(f=>activeFilter==='all'||f.status===activeFilter)
      .filter(f=>mapStatusFilter==='all'||f.status===mapStatusFilter)
      .filter(f=>!mapUfFilter||f.state===mapUfFilter)
      .filter(f=>!search||f.city.toLowerCase().includes(search));
    if(!items.length)return;
    const group=document.createElement('div'); group.className='state-group';
    group.innerHTML=`<div class="state-label">${state}</div>`;
    items.forEach(f=>{
      const item=document.createElement('div');
      item.className=`filial-item ${activeFilialIndex===f.idx?'active':''}`;
      item.id=`filial-${f.idx}`;
      item.innerHTML=`<div class="filial-dot ${f.status}"></div><span class="filial-name">${f.city}</span>
        <span class="filial-badge ${f.status==='visited'?'badge-visited':f.status==='pending'?'badge-pending':'badge-ok'}">${getStatusLabel(f.status)}</span>`;
      item.onclick=()=>{map.setView([f.lat,f.lng],11,{animate:true});markers[f.idx]?.openPopup();setActiveFilial(f.idx);};
      group.appendChild(item);
    });
    list.appendChild(group);
  });
}

function filterFiliais(){renderList();}
function setFilter(filter,btn){activeFilter=filter;document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderList();}
function updateStats(){
  document.getElementById('totalCount').textContent=FILIAIS.length;
  document.getElementById('visitedCount').textContent=FILIAIS.filter(f=>f.status==='visited').length;
  document.getElementById('pendingCount').textContent=FILIAIS.filter(f=>f.status!=='visited').length;
}

// ‚ïê‚ïê‚ïê MAP FILTERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMapStatus(status,btn){
  mapStatusFilter=status;
  document.querySelectorAll('[onclick^="setMapStatus"]').forEach(b=>b.className='map-chip');
  btn.classList.add(`active-status-${status}`); refreshMarkers(); renderList();
}
function setMapUf(uf,btn){
  if(mapUfFilter===uf){clearUfFilter();return;}
  mapUfFilter=uf;
  document.querySelectorAll('#ufChips .map-chip').forEach(b=>b.classList.remove('active-uf'));
  btn.classList.add('active-uf'); document.getElementById('clearUf').classList.add('visible');
  refreshMarkers(); renderList();
  if(!CONFIG.display.autozoom)return;
  if(STATE_BOUNDS[uf])map.fitBounds(STATE_BOUNDS[uf],{animate:true,padding:[40,40]});
  else{const pts=FILIAIS.filter(f=>f.state===uf);if(pts.length){const lats=pts.map(f=>f.lat),lngs=pts.map(f=>f.lng);map.fitBounds([[Math.min(...lats)-0.5,Math.min(...lngs)-0.5],[Math.max(...lats)+0.5,Math.max(...lngs)+0.5]],{animate:true,padding:[40,40]});}}
}
function clearUfFilter(){
  mapUfFilter=null;
  document.querySelectorAll('#ufChips .map-chip').forEach(b=>b.classList.remove('active-uf'));
  document.getElementById('clearUf').classList.remove('visible');
  refreshMarkers(); renderList(); map.flyTo([-8.5,-38.5],6,{animate:true,duration:1});
}
function buildUfChips(){
  const c=document.getElementById('ufChips'); c.innerHTML='';
  [...new Set(FILIAIS.map(f=>f.state))].sort().forEach(uf=>{
    const btn=document.createElement('button'); btn.className='map-chip'; btn.textContent=uf;
    btn.onclick=()=>setMapUf(uf,btn); c.appendChild(btn);
  });
}

// ‚ïê‚ïê‚ïê MODAL: VISITA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openVisitModal(){document.getElementById('visitModalOverlay').classList.add('open');document.getElementById('visitDate').value=new Date().toISOString().split('T')[0];}
function openVisitModalForFilial(idx){openVisitModal();document.getElementById('filialSelect').value=idx;}
function closeVisitModal(){document.getElementById('visitModalOverlay').classList.remove('open');}
function renderFilialTable(){
  const tbody=document.getElementById('filiaisTableBody'); tbody.innerHTML='';
  FILIAIS.forEach((f,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${f.city}</td><td><span class="state-tag">${f.state}</span></td>
      <td style="font-size:12px;color:var(--muted);font-variant-numeric:tabular-nums;">${f.lat.toFixed(4)}, ${f.lng.toFixed(4)}</td>
      <td><span class="filial-badge ${f.status==='visited'?'badge-visited':f.status==='pending'?'badge-pending':'badge-ok'}">${getStatusLabel(f.status)}</span></td>
      <td><div class="td-actions"><button class="btn btn-ghost btn-sm" onclick="openEditModal(${i})">‚úè Editar</button><button class="btn btn-danger btn-sm" onclick="deleteFilial(${i})">‚úï Remover</button></div></td>`;
    tbody.appendChild(tr);
  });
}
function showAddRow(){const f=document.getElementById('addFilialForm');f.style.display=f.style.display==='none'?'grid':'none';if(f.style.display==='grid')document.getElementById('newCity').focus();}
const COORD_FB={PB:[-7.12,-35.88],CE:[-3.72,-38.54],PE:[-8.05,-34.95],RN:[-5.79,-35.21],MA:[-2.53,-44.31],AL:[-9.67,-35.74],RJ:[-22.91,-43.17],SP:[-23.55,-46.63]};// ‚ïê‚ïê‚ïê MODAL: EDITAR FILIAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openEditModal(idx){
  const f=FILIAIS[idx];
  document.getElementById('editIdx').value=idx; document.getElementById('editCity').value=f.city;
  document.getElementById('editState').value=f.state; document.getElementById('editLat').value=f.lat;
  document.getElementById('editLng').value=f.lng; document.getElementById('editStatus').value=f.status;
  document.getElementById('editModalOverlay').classList.add('open');
}
function closeEditModal(){document.getElementById('editModalOverlay').classList.remove('open');}
// ‚ïê‚ïê‚ïê SETTINGS: STATUS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function syncColor(s){const h=document.getElementById(`conf-${s}-hex`).value;if(/^#[0-9a-fA-F]{6}$/.test(h)){document.getElementById(`conf-${s}-color`).value=h;previewConfig();}}
function previewConfig(){['ok','visited','pending'].forEach(s=>{const c=document.getElementById(`conf-${s}-color`).value;document.getElementById(`conf-${s}-hex`).value=c;document.getElementById(`conf-${s}-dot`).style.background=c;});}unction applyDisplaySettings(){
  const legend=document.getElementById('tog-legend').checked; const filters=document.getElementById('tog-filters').checked;
  const sidebar=document.getElementById('tog-sidebar').checked; const autozoom=document.getElementById('tog-autozoom').checked;
  CONFIG.display={legend,filters,sidebar,autozoom};
  document.getElementById('mapLegend').style.display=legend?'':'none';
  document.querySelector('.map-filters').style.display=filters?'':'none';
  const sb=document.getElementById('sidebar');
  if(!sidebar&&!sb.classList.contains('collapsed'))toggleSidebar();
  else if(sidebar&&sb.classList.contains('collapsed'))toggleSidebar();
}

// ‚ïê‚ïê‚ïê USERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getInitials(name){return name.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();}

function renderUsersGrid(){
  const grid=document.getElementById('usersGrid'); grid.innerHTML='';
  USERS.forEach(u=>{
    const meta=ROLE_META[u.role];
    const card=document.createElement('div'); card.className='user-card';
    card.innerHTML=`
      <div class="user-avatar" style="background:${meta.bg}22;color:${meta.bg};border:1.5px solid ${meta.bg}44;">${getInitials(u.name)}</div>
      <div class="user-info">
        <div class="user-name">${u.name}</div>
        <div class="user-email">${u.email}</div>
        <div class="user-meta">
          <span class="role-badge ${meta.cls}">${meta.icon} ${meta.label}</span>
          <span class="user-status-dot" style="background:${u.active?'#22c55e':'var(--muted)'}" title="${u.active?'Ativo':'Inativo'}"></span>
          <span style="font-size:10px;color:var(--muted)">${u.active?'Ativo':'Inativo'}</span>
        </div>
      </div>
      <div class="user-actions">
        <button class="btn btn-ghost btn-sm" onclick="openUserModal(${u.id})">‚úè</button>
        <button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">‚úï</button>
      </div>`;
    grid.appendChild(card);
  });
}

function updateRolePreview() {
  const ROLE_DESCRIPTIONS = {
    admin:   'Acesso irrestrito. Gerencia usu√°rios, configura√ß√µes, filiais e todos os registros de visita.',
    diretor: 'Apenas leitura estrat√©gica. Visualiza todos os relat√≥rios e hist√≥rico de visitas da equipe.',
    gerente: 'Gest√£o operacional. Registra e edita visitas, cadastra filiais, v√™ relat√≥rios da equipe.',
    coord:   'Execu√ß√£o em campo. Registra e consulta suas pr√≥prias visitas, visualiza mapa e filiais.',
  };
  const role = document.getElementById('userRole').value;
  const meta = ROLE_META[role];
  const desc = ROLE_DESCRIPTIONS[role];
  const el = document.getElementById('rolePreview');
  if (el) el.innerHTML = `<strong style="color:var(--text);">${meta.icon} ${meta.label}:</strong> ${desc}`;
}

function openUserModal(id){
  const u = id ? USERS.find(u => u.id === id) : null;
  document.getElementById('userModalTitle').textContent = u ? 'Editar Usu√°rio' : 'Novo Usu√°rio';
  document.getElementById('userModalSub').textContent = u ? `Editando dados de ${u.name}` : 'Preencha os dados do novo usu√°rio';
  document.getElementById('userId').value     = u ? u.id : '';
  document.getElementById('userName').value   = u ? u.name : '';
  document.getElementById('userEmail').value  = u ? u.email : '';
  document.getElementById('userPhone').value  = u ? (u.phone||'') : '';
  document.getElementById('userUF').value     = u ? (u.uf||'') : '';
  document.getElementById('userRole').value   = u ? u.role : 'coord';
  document.getElementById('userActive').value = u ? String(u.active) : 'true';
  document.getElementById('userPassGroup').style.display = u ? 'none' : '';
  updateRolePreview();
  document.getElementById('userModalOverlay').classList.add('open');
}

function closeUserModal(){ document.getElementById('userModalOverlay').classList.remove('open'); }

// ‚ïê‚ïê‚ïê USERS ‚Äî state ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let userRoleFilter = 'all';

function setUserRoleFilter(role, btn) {
  userRoleFilter = role;
  document.querySelectorAll('.role-filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  renderUsersGrid();
}

function renderUsersSummary() {
  const s = document.getElementById('usersSummary'); if (!s) return;
  const roles = [
    { key:'admin',   ...ROLE_META.admin,   color:'rgba(239,68,68,0.15)'   },
    { key:'diretor', ...ROLE_META.diretor, color:'rgba(168,85,247,0.15)'  },
    { key:'gerente', ...ROLE_META.gerente, color:'rgba(0,136,255,0.15)'   },
    { key:'coord',   ...ROLE_META.coord,   color:'rgba(0,212,170,0.15)'   },
  ];
  s.innerHTML = roles.map(r => {
    const total = USERS.filter(u => u.role === r.key).length;
    const ativos = USERS.filter(u => u.role === r.key && u.active).length;
    return `<div class="summary-card">
      <div class="summary-icon" style="background:${r.color};">${r.icon}</div>
      <div>
        <div class="summary-num">${total}</div>
        <div class="summary-label">${r.label}${total !== 1 ? 's' : ''}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px;">${ativos} ativo${ativos !== 1 ? 's' : ''}</div>
      </div>
    </div>`;
  }).join('');
}

// √öltimos acessos fict√≠cios para demo
const LAST_ACCESS = { 1:'Hoje, 09:14', 2:'Ontem, 16:32', 3:'Hoje, 11:05', 4:'15/01/2026', 5:'Hoje, 08:47', 6:'17/02/2026' };

function toggleUserActive(id) {
  const u = USERS.find(u => u.id === id);
  if (u) { u.active = !u.active; renderUsersGrid(); }
}

// ‚ïê‚ïê‚ïê PROFILES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeProfileTab = 'admin';

function renderProfilesGrid() {
  // Abas
  const tabs = document.getElementById('profilesTabs');
  const content = document.getElementById('profilesContent');
  if (!tabs || !content) return;

  tabs.innerHTML = Object.entries(ROLE_META).map(([key, meta]) => {
    const count = USERS.filter(u => u.role === key).length;
    return `<button class="profile-tab ${key === activeProfileTab ? 'active' : ''}" onclick="switchProfileTab('${key}',this)">
      <span class="profile-tab-icon">${meta.icon}</span>${meta.label}
      <span style="font-size:10px;background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:1px 7px;margin-left:4px;">${count}</span>
    </button>`;
  }).join('');

  renderProfilePane(activeProfileTab);
}

function switchProfileTab(key, btn) {
  activeProfileTab = key;
  document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderProfilePane(key);
}

function renderProfilePane(roleKey) {
  const content = document.getElementById('profilesContent');
  const meta = ROLE_META[roleKey];
  const isAdmin = roleKey === 'admin';
  const count = USERS.filter(u => u.role === roleKey).length;
  const ativos = USERS.filter(u => u.role === roleKey && u.active).length;

  const descriptions = {
    admin:   'Acesso total ao sistema. Pode configurar tudo, gerenciar usu√°rios e visualizar qualquer registro.',
    diretor: 'Vis√£o estrat√©gica. Pode consultar todos os relat√≥rios e hist√≥rico de visitas da equipe, sem alterar dados.',
    gerente: 'Gest√£o operacional. Pode registrar e editar visitas, gerenciar filiais e visualizar relat√≥rios da equipe.',
    coord:   'Execu√ß√£o em campo. Pode registrar suas pr√≥prias visitas e visualizar o mapa e lista de filiais.',
  };

  // Agrupar permiss√µes em 2 colunas
  const half = Math.ceil(PERM_GROUPS.length / 2);
  const col1 = PERM_GROUPS.slice(0, half);
  const col2 = PERM_GROUPS.slice(half);

  const renderGroup = (g) => {
    const rows = g.perms.map(p => {
      const checked = PROFILES[roleKey][p.key];
      const toggle = isAdmin
        ? `<span class="perm-always">‚úì Sempre</span>`
        : `<label class="toggle-switch" style="width:34px;height:20px;flex-shrink:0;">
             <input type="checkbox" ${checked ? 'checked' : ''} onchange="PROFILES['${roleKey}']['${p.key}']=this.checked">
             <span class="toggle-slider"></span>
           </label>`;
      return `<div class="perm-row">
        <div>
          <div class="perm-label">${p.label}</div>
          <div class="perm-sub">${p.sub}</div>
        </div>
        ${toggle}
      </div>`;
    }).join('');
    return `<div class="perm-section">
      <div class="perm-section-title">${g.group}</div>
      ${rows}
    </div>`;
  };

  content.innerHTML = `
    <div class="profile-hero">
      <div class="profile-hero-icon" style="background:${meta.bg}1a;">${meta.icon}</div>
      <div>
        <div class="profile-hero-name">${meta.label}</div>
        <div class="profile-hero-desc">${descriptions[roleKey]}</div>
        ${isAdmin ? '<div style="margin-top:6px;"><span style="font-size:11px;background:rgba(239,68,68,0.12);color:#f87171;border:1px solid rgba(239,68,68,0.25);padding:2px 9px;border-radius:6px;font-weight:600;">Permiss√µes bloqueadas ‚Äî acesso irrestrito</span></div>' : ''}
      </div>
      <div class="profile-hero-count">
        <div class="profile-hero-count-num">${count}</div>
        <div class="profile-hero-count-label">usu√°rio${count !== 1 ? 's' : ''}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:4px;">${ativos} ativo${ativos !== 1 ? 's' : ''}</div>
      </div>
    </div>
    <div class="perm-sections">
      <div>${col1.map(renderGroup).join('')}</div>
      <div>${col2.map(renderGroup).join('')}</div>
    </div>`;
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DADOS DE VISITAS / REGISTROS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeRecordId = null;
let visitTags = [];
let visitDemandasModal = [];

// Usu√°rio atual simulado (perfil: admin pode usar IA)
// permiss√£o IA: admin e diretor podem gerar resumo
// ‚îÄ‚îÄ RENDERIZAR LISTA DE REGISTROS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRecordsList() {
  const search = (document.getElementById('recSearch')?.value || '').toLowerCase();
  const ufF    = document.getElementById('recFilterUF')?.value || '';
  const resF   = document.getElementById('recFilterResult')?.value || '';
  const demF   = document.getElementById('recFilterDemanda')?.value || '';

  let list = VISITS.filter(v => {
    const f = FILIAIS[v.filialIdx] || {};
    const matchSearch = !search ||
      f.city?.toLowerCase().includes(search) ||
      v.responsavel?.toLowerCase().includes(search) ||
      v.temas?.some(t => t.toLowerCase().includes(search)) ||
      v.obs?.toLowerCase().includes(search);
    const matchUF  = !ufF  || f.state === ufF;
    const matchRes = !resF || v.result === resF;
    const matchDem = !demF || (() => {
      if (demF==='open')   return v.demandas.some(d=>d.status==='open');
      if (demF==='solved') return v.demandas.some(d=>d.status==='solved');
      if (demF==='dep')    return v.demandas.some(d=>d.status==='dep');
      return true;
    })();
    return matchSearch && matchUF && matchRes && matchDem;
  }).sort((a,b) => b.date.localeCompare(a.date));

  document.getElementById('recListCount').textContent = `${list.length} registro${list!==1?'s':''}`;

  const container = document.getElementById('recListItems');
  container.innerHTML = '';

  if (!list.length) {
    container.innerHTML = '<div style="padding:32px;text-align:center;color:var(--muted);font-size:13px;">Nenhum registro encontrado</div>';
    return;
  }

  list.forEach(v => {
    const f = FILIAIS[v.filialIdx] || {};
    const openCount   = v.demandas.filter(d=>d.status==='open').length;
    const depCount    = v.demandas.filter(d=>d.status==='dep').length;
    const solvedCount = v.demandas.filter(d=>d.status==='solved').length;
    const dateStr = new Date(v.date+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'});

    const resMap = { visited:'chip-result-visited', pending:'chip-result-pending', ok:'chip-result-ok' };
    const resLabel = { visited:'Realizada', pending:'Pendente', ok:'Acompanhamento' };

    const item = document.createElement('div');
    item.className = 'rec-item' + (v.id===activeRecordId?' active':'');
    item.onclick = () => showRecordDetail(v.id);
    item.innerHTML = `
      <div class="rec-item-header">
        <div class="rec-item-city">${f.city||'‚Äî'}</div>
        <div class="rec-item-date">${dateStr}</div>
      </div>
      <div class="rec-item-meta">
        <span class="rec-item-state">${f.state||'‚Äî'}</span>
        <span class="rec-item-user">¬∑ ${v.responsavel}</span>
      </div>
      <div style="margin-top:7px;display:flex;gap:5px;flex-wrap:wrap;">
        ${openCount   ? `<span class="rec-demand-pill dp-open">‚ö° ${openCount} aberta${openCount!==1?'s':''}</span>` : ''}
        ${depCount    ? `<span class="rec-demand-pill dp-pend">‚è∏ ${depCount} aguardando</span>` : ''}
        ${solvedCount ? `<span class="rec-demand-pill dp-solved">‚úì ${solvedCount} resolvida${solvedCount!==1?'s':''}</span>` : ''}
        ${v.temas.length ? `<span style="font-size:10px;color:var(--muted);margin-top:2px;">${v.temas.slice(0,2).join(' ¬∑ ')}${v.temas.length>2?' +'+( v.temas.length-2):''}</span>` : ''}
      </div>`;
    container.appendChild(item);
  });
}

// ‚îÄ‚îÄ DETALHE DO REGISTRO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showRecordDetail(id) {
  activeRecordId = id;
  document.querySelectorAll('.rec-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.rec-item').forEach(el => {
    if (el.onclick.toString().includes(id)) el.classList.add('active');
  });
  renderRecordsList(); // re-render list to mark active

  const v = VISITS.find(x=>x.id===id);
  if (!v) return;
  const f = FILIAIS[v.filialIdx] || {};
  const dateStr = new Date(v.date+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'long',year:'numeric'});
  const resLabel = { visited:'Visita realizada', pending:'Pendente retorno', ok:'Em acompanhamento' };
  const resClass = { visited:'chip-result-visited', pending:'chip-result-pending', ok:'chip-result-ok' };

  const demandasHTML = v.demandas.length ? v.demandas.map(d => {
    const icons = { solved:'‚úì', open:'‚ö°', dep:'‚è∏' };
    const classes = { solved:'dem-solved', open:'dem-open', dep:'dem-dep' };
    const labels = { solved:'Resolvida', open:'Em aberto', dep:'Aguardando' };
    const depHTML = d.status==='dep' && d.depValor ? `
      <div class="demanda-dep">
        <span class="demanda-dep-label">${d.depTipo==='depto'?'Departamento':'Respons√°vel'}</span>
        <span class="demanda-dep-value">${d.depValor}</span>
      </div>` : '';
    return `<div class="demanda-card">
      <div class="demanda-card-header">
        <span class="demanda-status-icon ${classes[d.status]}">${icons[d.status]}</span>
        <span class="demanda-text">${d.text}</span>
      </div>
      ${depHTML}
    </div>`;
  }).join('') : '<div style="color:var(--muted);font-size:13px;padding:4px 0;">Nenhuma demanda registrada.</div>';

  const aiBlock = canUseAI() ? `
    <div class="rec-section">
      <div class="rec-section-header">
        <div class="rec-section-icon" style="background:linear-gradient(135deg,rgba(0,212,170,0.2),rgba(0,136,255,0.2));">‚ú®</div>
        <div class="rec-section-title">Resumo por IA</div>
        <span class="ai-resumo-badge">BETA</span>
        <button class="btn btn-ghost btn-sm" onclick="generateAISummary('${id}')" style="margin-left:8px;">Gerar resumo</button>
      </div>
      <div class="rec-section-body">
        <div class="ai-resumo-box">
          <div class="ai-resumo-text" id="aiSummary-${id}">Clique em "Gerar resumo" para que a IA analise este registro e produza um resumo executivo.</div>
          <div class="ai-resumo-actions">
            <button class="btn btn-ghost btn-sm" onclick="generateAISummary('${id}')">üîÑ Regenerar</button>
          </div>
        </div>
      </div>
    </div>` : `
    <div class="rec-section">
      <div class="rec-section-header">
        <div class="rec-section-icon" style="background:rgba(107,122,153,0.1);">üîí</div>
        <div class="rec-section-title">Resumo por IA</div>
      </div>
      <div class="rec-section-body">
        <div class="ai-locked">
          <div class="ai-locked-icon">üîê</div>
          <div class="ai-locked-text">Seu perfil n√£o tem permiss√£o para usar o resumo por IA.<br>Solicite acesso ao administrador do sistema.</div>
        </div>
      </div>
    </div>`;

  document.getElementById('recDetail').innerHTML = `
    <!-- HERO -->
    <div class="rec-detail-hero">
      <div class="rec-detail-eyebrow">Filial ¬∑ ${f.state||'‚Äî'}</div>
      <div class="rec-detail-title">${f.city||'‚Äî'}</div>
      <div class="rec-detail-sub">${f.state ? (STATE_NAMES[f.state]||f.state) : ''}</div>
      <div class="rec-detail-chips">
        <span class="rec-detail-chip ${resClass[v.result]}">${resLabel[v.result]}</span>
        <span class="rec-detail-chip chip-user">üë§ ${v.responsavel}</span>
        <span class="rec-detail-chip chip-date">üìÖ ${dateStr}</span>
        <button class="btn btn-ghost btn-sm" onclick="openEditVisitModal('${id}')" style="margin-left:auto;">‚úè Editar</button>
        <button class="btn btn-danger btn-sm" onclick="deleteVisit('${id}')">‚úï Excluir</button>
      </div>
    </div>

    <div class="rec-sections">

      <!-- TEMAS -->
      <div class="rec-section">
        <div class="rec-section-header">
          <div class="rec-section-icon" style="background:rgba(0,136,255,0.12);">üí¨</div>
          <div class="rec-section-title">Temas abordados</div>
          <span class="rec-section-count">${v.temas.length}</span>
        </div>
        <div class="rec-section-body" style="flex-direction:row;flex-wrap:wrap;gap:0;">
          ${v.temas.length
            ? v.temas.map(t=>`<span class="tema-chip">üè∑ ${t}</span>`).join('')
            : '<span style="color:var(--muted);font-size:13px;">Nenhum tema registrado.</span>'
          }
        </div>
      </div>

      <!-- DEMANDAS -->
      <div class="rec-section">
        <div class="rec-section-header">
          <div class="rec-section-icon" style="background:rgba(255,107,53,0.12);">üìå</div>
          <div class="rec-section-title">Demandas</div>
          <span class="rec-section-count">${v.demandas.length}</span>
        </div>
        <div class="rec-section-body">
          ${demandasHTML}
        </div>
      </div>

      <!-- OBSERVA√á√ïES -->
      <div class="rec-section">
        <div class="rec-section-header">
          <div class="rec-section-icon" style="background:rgba(0,212,170,0.12);">üìù</div>
          <div class="rec-section-title">Observa√ß√µes gerais</div>
        </div>
        <div class="rec-section-body">
          <div class="obs-text">${v.obs || 'Nenhuma observa√ß√£o registrada.'}</div>
        </div>
      </div>

      <!-- IA -->
      ${aiBlock}

    </div>`;
}

// ‚îÄ‚îÄ AI SUMMARY VIA ANTHROPIC API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateAISummary(visitId) {
  const v = VISITS.find(x=>x.id===visitId);
  if (!v) return;
  const f = FILIAIS[v.filialIdx] || {};

  const el = document.getElementById('aiSummary-'+visitId);
  if (!el) return;
  el.textContent = 'Analisando o registro... ‚ú®';
  el.className = 'ai-resumo-text loading';

  const demandasTxt = v.demandas.map((d,i) => {
    const s = {solved:'Resolvida',open:'Em aberto',dep:'Aguardando terceiros'}[d.status];
    const dep = d.depValor ? ` (depend√™ncia: ${d.depTipo==='depto'?'Depto.':''} ${d.depValor})` : '';
    return `${i+1}. [${s}] ${d.text}${dep}`;
  }).join('\n');

  const prompt = `Voc√™ √© um assistente executivo analisando relat√≥rios de visita a filiais comerciais. Produza um resumo executivo conciso e profissional do seguinte registro de visita.

DADOS DA VISITA:
- Filial: ${f.city} ‚Äî ${f.state}
- Data: ${v.date}
- Respons√°vel: ${v.responsavel}
- Resultado geral: ${{visited:'Visita realizada',pending:'Pendente retorno',ok:'Em acompanhamento'}[v.result]}
- Temas abordados: ${v.temas.join(', ') || 'N√£o informado'}
- Demandas:
${demandasTxt || 'Nenhuma demanda'}
- Observa√ß√µes: ${v.obs || 'Nenhuma observa√ß√£o'}

Estruture o resumo em 3 partes curtas:
1. **Situa√ß√£o geral** (1-2 frases sobre o contexto da visita)
2. **Principais a√ß√µes necess√°rias** (liste as demandas em aberto de forma objetiva)
3. **Recomenda√ß√£o** (1 frase com a prioridade para o pr√≥ximo passo)

Seja direto, objetivo e use linguagem executiva. M√°ximo 180 palavras.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:600,
        messages:[{ role:'user', content:prompt }]
      })
    });
    const data = await response.json();
    const text = data.content?.[0]?.text || 'N√£o foi poss√≠vel gerar o resumo.';
    el.textContent = text;
    el.className = 'ai-resumo-text';
  } catch(err) {
    el.textContent = 'Erro ao conectar com a IA. Verifique sua conex√£o.';
    el.className = 'ai-resumo-text';
  }
}

// ‚îÄ‚îÄ MODAL DE VISITA: abrir/fechar/editar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditVisitModal(id) {
  const v = VISITS.find(x=>x.id===id);
  if (!v) return;
  visitTags = [...v.temas];
  visitDemandasModal = v.demandas.map((d,i) => ({id:'d'+Date.now()+i,...d}));
  document.getElementById('visitEditId').value = id;
  document.getElementById('visitModalTitle').textContent = 'Editar Registro';
  document.getElementById('visitModalSub').textContent = 'Atualize os dados da visita';
  document.getElementById('filialSelect').value = v.filialIdx;
  document.getElementById('visitDate').value = v.date;
  document.getElementById('visitResponsavel').value = v.responsavel;
  document.getElementById('visitResult').value = v.result;
  document.getElementById('visitObs').value = v.obs;
  renderTagsUI();
  renderDemandasModal();
  document.getElementById('visitModalOverlay').classList.add('open');
}

// ‚îÄ‚îÄ TAGS (temas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleTagInput(e) {
  if (e.key==='Enter'||e.key===',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(/,$/, '');
    if (val && !visitTags.includes(val)) { visitTags.push(val); renderTagsUI(); }
    e.target.value = '';
  } else if (e.key==='Backspace' && e.target.value==='' && visitTags.length) {
    visitTags.pop(); renderTagsUI();
  }
}

function removeTag(i) { visitTags.splice(i,1); renderTagsUI(); }

function renderTagsUI() {
  const wrap = document.getElementById('temasWrap');
  const input = document.getElementById('temasInput');
  const tags = visitTags.map((t,i) => `<span class="tag-item">${t}<span class="tag-remove" onclick="removeTag(${i})">√ó</span></span>`).join('');
  wrap.innerHTML = tags + '<input class="tags-input" id="temasInput" placeholder="' + (visitTags.length?'':'Digite um tema e pressione Enter...') + '" onkeydown="handleTagInput(event)"/>';
}

// ‚îÄ‚îÄ DEMANDAS NO MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let demandaIdCounter = 0;

function addDemandaItem(data) {
  const id = 'd' + (++demandaIdCounter);
  visitDemandasModal.push({ id, text: data?.text||'', status: data?.status||'open', depTipo: data?.depTipo||'depto', depValor: data?.depValor||'' });
  renderDemandasModal();
  setTimeout(()=>document.getElementById('dem-text-'+id)?.focus(),50);
}

function removeDemandaItem(id) {
  visitDemandasModal = visitDemandasModal.filter(d=>d.id!==id);
  renderDemandasModal();
}

function renderDemandasModal() {
  const list = document.getElementById('demandasList');
  if (!list) return;
  if (!visitDemandasModal.length) { list.innerHTML = ''; return; }

  const deptoOptions = DEPARTAMENTOS.map(d=>`<option value="${d}">${d}</option>`).join('');
  const userOptions  = USERS.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');

  list.innerHTML = visitDemandasModal.map(d => {
    const isDep = d.status === 'dep';
    return `<div class="demanda-modal-item">
      <div class="demanda-modal-item-header">
        <select id="dem-status-${d.id}" onchange="updateDemandaStatus('${d.id}',this.value)">
          <option value="open"  ${d.status==='open'  ?'selected':''}>‚ö° Em aberto</option>
          <option value="solved"${d.status==='solved'?'selected':''}>‚úì Resolvida</option>
          <option value="dep"   ${d.status==='dep'   ?'selected':''}>‚è∏ Aguardando</option>
        </select>
        <button class="btn btn-danger btn-sm" onclick="removeDemandaItem('${d.id}')">‚úï</button>
      </div>
      <textarea style="width:100%;padding:7px 10px;background:var(--panel);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Inter',sans-serif;font-size:13px;outline:none;resize:vertical;min-height:52px;" id="dem-text-${d.id}" placeholder="Descreva a demanda...">${d.text||''}</textarea>
      ${isDep ? `<div class="demanda-dep-row">
        <select id="dem-dep-tipo-${d.id}" onchange="updateDemandaDepTipo('${d.id}',this.value)" style="max-width:140px;">
          <option value="depto"  ${d.depTipo==='depto' ?'selected':''}>üè¢ Departamento</option>
          <option value="pessoa" ${d.depTipo==='pessoa'?'selected':''}>üë§ Pessoa</option>
        </select>
        ${d.depTipo==='pessoa'
          ? `<select id="dem-dep-valor-${d.id}">${userOptions.replace(`>${d.depValor||''}<`,` selected>${d.depValor||''}<`)}</select>`
          : `<select id="dem-dep-valor-${d.id}">${deptoOptions.replace(`>${d.depValor||''}<`,` selected>${d.depValor||''}<`)}</select>`
        }
      </div>` : ''}
    </div>`;
  }).join('');
}

function updateDemandaStatus(id, val) {
  const d = visitDemandasModal.find(x=>x.id===id);
  if (d) { d.status=val; if(val!=='dep'){d.depTipo=null;d.depValor=null;} else {d.depTipo='depto';} renderDemandasModal(); }
}

function updateDemandaDepTipo(id, val) {
  const d = visitDemandasModal.find(x=>x.id===id);
  if (d) { d.depTipo=val; d.depValor=''; renderDemandasModal(); }
}

// ‚îÄ‚îÄ OVERRIDE: showView para incluir records ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origShowView = showView;
// patch showView to handle records tab
window.showView = function(view) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active','active-settings'));
  document.getElementById('view-'+view).classList.add('active');
  const tab = document.getElementById('tab-'+view);
  if (tab) tab.classList.add(view==='settings'?'active-settings':'active');
  if (view==='map') setTimeout(()=>map.invalidateSize(),50);
  if (view==='settings') renderFilialTable();
  if (view==='records') renderRecordsList();
};



// ‚ïê‚ïê‚ïê NOTIFICA√á√ïES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICA√á√ïES ‚Äî CONFIG (persistente via window.storage)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_MSG_TEMPLATE =
`üìã *Novo Relat√≥rio de Visita*

üè¢ *Filial:* {filial} ‚Äî {uf}
üìÖ *Data:* {data}
üë§ *Respons√°vel:* {responsavel}
üìä *Resultado:* {resultado}

üí¨ *Temas abordados:*
{temas}

üìå *Demandas:* {total_demandas} total ¬∑ {demandas_abertas} em aberto

üìù *Observa√ß√µes:*
{observacoes}

_Mensagem autom√°tica ‚Äî VisitaFiliais_`;

function applyNotifConfigToUI() {
  const el = id => document.getElementById(id);
  if (!el('notifGlobalEnabled')) return;
  el('notifGlobalEnabled').checked = NOTIF_CONFIG.globalEnabled;
  el('waEnabled').checked   = NOTIF_CONFIG.wa.enabled;
  el('waWebhookUrl').value  = NOTIF_CONFIG.wa.webhookUrl;
  el('waToken').value       = NOTIF_CONFIG.wa.token;
  el('waTarget').value      = NOTIF_CONFIG.wa.target;
  el('tgEnabled').checked   = NOTIF_CONFIG.tg.enabled;
  el('tgBotToken').value    = NOTIF_CONFIG.tg.botToken;
  el('tgChatId').value      = NOTIF_CONFIG.tg.chatId;
  el('tgWebhookUrl').value  = NOTIF_CONFIG.tg.webhookUrl;
  el('notifMsgTemplate').value = NOTIF_CONFIG.msgTemplate || DEFAULT_MSG_TEMPLATE;
  renderRecipientsList();
  renderRecipientSelect();
}

function resetMsgTemplate() {
  document.getElementById('notifMsgTemplate').value = DEFAULT_MSG_TEMPLATE;
  saveNotifConfig();
}

// ‚îÄ‚îÄ DESTINAT√ÅRIOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRecipientsList() {
  const container = document.getElementById('recipientsList');
  if (!container) return;
  if (!NOTIF_CONFIG.recipients.length) {
    container.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:4px 0;">Nenhum destinat√°rio configurado. Adicione usu√°rios abaixo.</div>';
    return;
  }
  container.innerHTML = NOTIF_CONFIG.recipients.map(uid => {
    const u = USERS.find(x=>x.id===uid);
    if (!u) return '';
    const meta = ROLE_META[u.role];
    return `<div class="recipient-row">
      <div class="recipient-avatar" style="background:${meta.bg}22;color:${meta.bg};">${getInitials(u.name)}</div>
      <div class="recipient-info">
        <div class="recipient-name">${u.name}</div>
        <div class="recipient-role">${meta.icon} ${meta.label} ¬∑ ${u.email}</div>
      </div>
      <span class="recipient-remove" onclick="removeRecipient(${uid})" title="Remover">√ó</span>
    </div>`;
  }).join('');
}

function renderRecipientSelect() {
  const sel = document.getElementById('recipientUserSelect');
  if (!sel) return;
  const existing = new Set(NOTIF_CONFIG.recipients);
  sel.innerHTML = '<option value="">Selecionar usu√°rio para adicionar...</option>' +
    USERS.filter(u=>!existing.has(u.id)).map(u =>
      `<option value="${u.id}">${u.name} ‚Äî ${ROLE_META[u.role].label}</option>`
    ).join('');
}

function addRecipient() {
  const sel = document.getElementById('recipientUserSelect');
  const uid = parseInt(sel.value);
  if (!uid) return;
  if (!NOTIF_CONFIG.recipients.includes(uid)) {
    NOTIF_CONFIG.recipients.push(uid);
    saveNotifConfig();
    renderRecipientsList();
    renderRecipientSelect();
  }
}

function removeRecipient(uid) {
  NOTIF_CONFIG.recipients = NOTIF_CONFIG.recipients.filter(x=>x!==uid);
  saveNotifConfig();
  renderRecipientsList();
  renderRecipientSelect();
}

// ‚îÄ‚îÄ TESTE DE WEBHOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function testWebhook(channel) {
  await saveNotifConfig();
  const statusEl = document.getElementById(channel+'TestStatus');
  statusEl.style.display = 'inline-flex';
  statusEl.className = 'notif-status off';
  statusEl.textContent = '‚è≥ Testando...';

  const payload = buildNotifPayload({
    id:'TEST', filialIdx:6, date:new Date().toISOString().split('T')[0],
    responsavel:'Teste', result:'visited',
    temas:['Teste de webhook'], demandas:[], obs:'Mensagem de teste ‚Äî VisitaFiliais'
  });

  try {
    let url, headers = { 'Content-Type':'application/json' }, body;
    if (channel === 'wa') {
      if (!NOTIF_CONFIG.wa.webhookUrl) throw new Error('URL n√£o configurada');
      url = NOTIF_CONFIG.wa.webhookUrl;
      if (NOTIF_CONFIG.wa.token) headers['Authorization'] = 'Bearer ' + NOTIF_CONFIG.wa.token;
      body = JSON.stringify({ ...payload, target: NOTIF_CONFIG.wa.target });
    } else {
      if (!NOTIF_CONFIG.tg.botToken && !NOTIF_CONFIG.tg.webhookUrl) throw new Error('Token n√£o configurado');
      url = NOTIF_CONFIG.tg.webhookUrl ||
            `https://api.telegram.org/bot${NOTIF_CONFIG.tg.botToken}/sendMessage`;
      body = JSON.stringify({ chat_id: NOTIF_CONFIG.tg.chatId, text: payload.text, parse_mode:'Markdown' });
    }
    const res = await fetch(url, { method:'POST', headers, body });
    if (res.ok) {
      statusEl.className = 'notif-status ok'; statusEl.textContent = '‚úì Conex√£o bem-sucedida';
    } else {
      statusEl.className = 'notif-status err'; statusEl.textContent = `‚úó Erro ${res.status}`;
    }
  } catch(e) {
    statusEl.className = 'notif-status err';
    statusEl.textContent = '‚úó ' + (e.message || 'Erro de conex√£o');
  }
}

// ‚îÄ‚îÄ CONSTRUIR PAYLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildNotifPayload(v) {
  const f = FILIAIS[v.filialIdx] || {};
  const resLabel = { visited:'‚úÖ Visita realizada', pending:'‚è≥ Pendente retorno', ok:'üëÅ Em acompanhamento' };
  const tpl = (NOTIF_CONFIG.msgTemplate || DEFAULT_MSG_TEMPLATE)
    .replace(/{filial}/g,          f.city || '‚Äî')
    .replace(/{uf}/g,              f.state || '‚Äî')
    .replace(/{data}/g,            new Date(v.date+'T12:00:00').toLocaleDateString('pt-BR'))
    .replace(/{responsavel}/g,     v.responsavel || '‚Äî')
    .replace(/{resultado}/g,       resLabel[v.result] || v.result)
    .replace(/{temas}/g,           v.temas.length ? v.temas.map(t=>'‚Ä¢ '+t).join('\n') : '‚Äî')
    .replace(/{total_demandas}/g,  String(v.demandas.length))
    .replace(/{demandas_abertas}/g,String(v.demandas.filter(d=>d.status==='open').length))
    .replace(/{observacoes}/g,     v.obs || '‚Äî');
  return { text: tpl, visit_id: v.id, filial: f.city, uf: f.state, data: v.date };
}

// ‚îÄ‚îÄ DISPARAR NOTIFICA√á√ïES (silencioso) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fireNotifications(visit) {
  if (!NOTIF_CONFIG.globalEnabled) return;
  const payload = buildNotifPayload(visit);

  // WhatsApp
  if (NOTIF_CONFIG.wa.enabled && NOTIF_CONFIG.wa.webhookUrl) {
    try {
      const headers = { 'Content-Type':'application/json' };
      if (NOTIF_CONFIG.wa.token) headers['Authorization'] = 'Bearer ' + NOTIF_CONFIG.wa.token;
      await fetch(NOTIF_CONFIG.wa.webhookUrl, {
        method:'POST', headers,
        body: JSON.stringify({ ...payload, target: NOTIF_CONFIG.wa.target })
      });
    } catch(e) { /* silencioso */ }
  }

  // Telegram
  if (NOTIF_CONFIG.tg.enabled && (NOTIF_CONFIG.tg.botToken || NOTIF_CONFIG.tg.webhookUrl)) {
    try {
      const url = NOTIF_CONFIG.tg.webhookUrl ||
                  `https://api.telegram.org/bot${NOTIF_CONFIG.tg.botToken}/sendMessage`;
      await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ chat_id: NOTIF_CONFIG.tg.chatId, text: payload.text, parse_mode:'Markdown' })
      });
    } catch(e) { /* silencioso */ }
  }
}


// ‚ïê‚ïê‚ïê RASCUNHO UI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ VERIFICAR E EXIBIR BANNER DE RASCUNHO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkDraftBanner() {
  const draft = await loadDraftFromStorage();
  const banner = document.getElementById('draftBanner');
  if (!banner) return;
  if (draft) {
    const f = FILIAIS[draft.filialIdx];
    const dt = new Date(draft.savedAt).toLocaleString('pt-BR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
    const info = f ? `${f.city}/${f.state}` : 'filial n√£o identificada';
    document.getElementById('draftBannerInfo').textContent = `${info} ¬∑ Salvo em ${dt}`;
    banner.classList.add('visible');
  } else {
    banner.classList.remove('visible');
  }
}

// ‚îÄ‚îÄ RETOMAR RASCUNHO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function resumeDraft() {
  const draft = await loadDraftFromStorage();
  if (!draft) return;

  visitTags = draft.temas || [];
  visitDemandasModal = (draft.demandas || []).map(d => ({...d}));

  document.getElementById('visitEditId').value       = draft.editId || '';
  document.getElementById('visitModalTitle').textContent = draft.editId ? 'Editar Registro (rascunho)' : 'Novo Relat√≥rio (rascunho)';
  document.getElementById('visitModalSub').textContent   = 'üìù Continuando a partir do rascunho salvo';
  document.getElementById('filialSelect').value      = draft.filialIdx;
  document.getElementById('visitDate').value         = draft.date;
  document.getElementById('visitResponsavel').value  = draft.responsavel;
  document.getElementById('visitResult').value       = draft.result;
  document.getElementById('visitObs').value          = draft.obs;

  renderTagsUI();
  renderDemandasModal();

  // marca visualmente que est√° em modo rascunho
  const footer = document.querySelector('.visit-modal-footer');
  if (footer) {
    const draftNote = document.createElement('div');
    draftNote.style.cssText = 'font-size:11px;color:#f59e0b;display:flex;align-items:center;gap:4px;';
    draftNote.innerHTML = '‚ö† Rascunho em edi√ß√£o';
    document.querySelector('.visit-modal-footer-left')?.appendChild(draftNote);
  }

  document.getElementById('visitModalOverlay').classList.add('open');
}

// ‚îÄ‚îÄ DESCARTAR RASCUNHO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function discardDraft() {
  if (!confirm('Descartar o rascunho salvo? Esta a√ß√£o n√£o pode ser desfeita.')) return;
  await clearDraftFromStorage();
  await checkDraftBanner();
  showToast('Rascunho descartado.', 'muted');
}

// ‚îÄ‚îÄ AUTO-SAVE RASCUNHO (ao fechar modal sem salvar) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Substitu√≠da pela a√ß√£o expl√≠cita do bot√£o "Salvar rascunho"


// ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST GEN√âRICO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg, type='ok') {
  const colors = {
    ok:   { bg:'#111827', border:'#00d4aa', color:'#00d4aa' },
    warn: { bg:'#111827', border:'#f59e0b', color:'#f59e0b' },
    err:  { bg:'#111827', border:'#ef4444', color:'#ef4444' },
    muted:{ bg:'#111827', border:'#263554', color:'#6b7a99' },
  };
  const c = colors[type] || colors.ok;
  const el = document.createElement('div');
  el.style.cssText = `position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(8px);
    background:${c.bg};border:1px solid ${c.border};color:${c.color};
    padding:11px 22px;border-radius:10px;font-size:13px;font-weight:500;
    z-index:9999;box-shadow:0 4px 24px rgba(0,0,0,0.5);
    transition:opacity 0.25s,transform 0.25s;opacity:0;pointer-events:none;white-space:nowrap;`;
  el.textContent = msg;
  document.body.appendChild(el);
  requestAnimationFrame(() => { el.style.opacity='1'; el.style.transform='translateX(-50%) translateY(0)'; });
  setTimeout(() => {
    el.style.opacity='0'; el.style.transform='translateX(-50%) translateY(8px)';
    setTimeout(()=>el.remove(), 300);
  }, 3000);
}


</script>
</body>
</html>
